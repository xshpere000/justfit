# JustFit 数据库设计文档

## 0. 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 数据库设计文档 |
| 版本 | v1.0 |
| 日期 | 2026-02-07 |
| 项目版本 | v0.0.1 Beta |
| 数据库类型 | SQLite 3.x |

## 1. 数据库概述

### 1.1 设计原则

- 规范化设计，避免数据冗余
- 合理使用索引，优化查询性能
- 支持时序数据的高效存储与查询
- 支持数据分区与清理策略

### 1.2 命名规范

| 规则 | 说明 |
|------|------|
| 表名 | 小写, 复数形式, 下划线分隔 |
| 字段名 | 小写, 下划线分隔 |
| 主键 | id (UUID 或 自增整数) |
| 外键 | {table}_id |
| 时间字段 | _at 后缀 (created_at, updated_at) |
| 布尔字段 | is_ 前缀 |

## 2. 数据库 Schema

### 2.1 ER 图

```
┌─────────────┐       ┌─────────────┐       ┌─────────────┐
│  clusters   │1     *│    hosts    │1     *│     vms     │
├─────────────┤───────├─────────────┤───────├─────────────┤
│ id          │       │ id          │       │ id          │
│ name        │       │ cluster_id  │       │ host_id     │
│ vendor      │       │ name        │       │ name        │
│ region      │       │ cpu         │       │ vcpu        │
│ total_cpu   │       │ mem         │       │ vmem        │
│ total_mem   │       │ disk        │       │ vdisk       │
│ total_disk  │       │ status      │       │ os_type     │
│ status      │       │ created_at  │       │ power_state │
│ created_at  │       └─────────────┘       │ created_at  │
└─────────────┘                               └─────────────┘
       │                                              │
       │                                              │
       └──────────────────────────────────────────────┘
                             │
                             │ 1
                             │
                             │ *
                    ┌─────────────────────┐
                    │       metrics       │
├───────────────────┤                     |
                    │ id                  │
                    │ entity_type         │
                    │ entity_id           │
                    │ metric_name         │
                    │ timestamp           │
                    │ value               │
                    │ unit                │
                    │ created_at          │
                    └─────────────────────┘

┌─────────────┐       ┌─────────────┐
│ connections │       │    tasks    │
├─────────────┤       ├─────────────┤
│ id          │       │ id          │
│ name        │       │ type        │
│ type        │       │ status      │
│ endpoint    │       │ connection_id│
│ credentials │       │ config      │
│ status      │       │ started_at  │
│ last_sync   │       │ ended_at    │
│ created_at  │       │ error       │
└─────────────┘       │ progress    │
                      │ created_at  │
                      └─────────────┘

┌─────────────┐       ┌─────────────┐
│   reports   │       │   alerts    │
├─────────────┤       ├─────────────┤
│ id          │       │ id          │
│ task_id     │       │ entity_type │
│ type        │       │ entity_id   │
│ entity_type │       │ alert_type  │
│ entity_id   │       │ severity    │
│ summary     │       │ message     │
│ detail      │       │ is_read     │
│ format      │       │ is_resolved │
│ file_path   │       │ created_at  │
│ created_at  │       └─────────────┘
└─────────────┘
```

### 2.2 表结构定义

#### 2.2.1 clusters - 集群表

```sql
CREATE TABLE clusters (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    vendor TEXT NOT NULL,                    -- 'vcenter', 'h3c', etc.
    region TEXT,
    datacenter TEXT,
    total_cpu INTEGER NOT NULL DEFAULT 0,    -- 总 CPU 核数
    total_mem INTEGER NOT NULL DEFAULT 0,    -- 总内存 (MB)
    total_disk INTEGER NOT NULL DEFAULT 0,   -- 总磁盘 (GB)
    used_cpu REAL DEFAULT 0,                 -- 已用 CPU
    used_mem REAL DEFAULT 0,                 -- 已用内存 (MB)
    used_disk REAL DEFAULT 0,                -- 已用磁盘 (GB)
    health_score REAL,                       -- 健康评分 (0-100)
    status TEXT DEFAULT 'active',            -- 'active', 'inactive', 'error'
    metadata TEXT,                           -- JSON 扩展字段
    created_at INTEGER NOT NULL,             -- Unix timestamp
    updated_at INTEGER NOT NULL              -- Unix timestamp
);

CREATE INDEX idx_clusters_vendor ON clusters(vendor);
CREATE INDEX idx_clusters_status ON clusters(status);
```

#### 2.2.2 hosts - 主机表

```sql
CREATE TABLE hosts (
    id TEXT PRIMARY KEY,
    cluster_id TEXT NOT NULL,
    connection_id TEXT NOT NULL,
    name TEXT NOT NULL,
    ip_address TEXT,
    cpu_total INTEGER NOT NULL DEFAULT 0,     -- CPU 核数
    mem_total INTEGER NOT NULL DEFAULT 0,     -- 内存 (MB)
    disk_total INTEGER NOT NULL DEFAULT 0,    -- 磁盘 (GB)
    cpu_used REAL DEFAULT 0,                 -- 已用 CPU
    mem_used REAL DEFAULT 0,                 -- 已用内存 (MB)
    disk_used REAL DEFAULT 0,                -- 已用磁盘 (GB)
    vm_count INTEGER DEFAULT 0,              -- 虚拟机数量
    health_score REAL,                       -- 健康评分 (0-100)
    status TEXT DEFAULT 'active',            -- 'active', 'maintenance', 'error'
    metadata TEXT,                           -- JSON 扩展字段
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (cluster_id) REFERENCES clusters(id) ON DELETE CASCADE,
    FOREIGN KEY (connection_id) REFERENCES connections(id) ON DELETE CASCADE
);

CREATE INDEX idx_hosts_cluster ON hosts(cluster_id);
CREATE INDEX idx_hosts_connection ON hosts(connection_id);
CREATE INDEX idx_hosts_status ON hosts(status);
```

#### 2.2.3 vms - 虚拟机表

```sql
CREATE TABLE vms (
    id TEXT PRIMARY KEY,
    host_id TEXT NOT NULL,
    cluster_id TEXT,
    name TEXT NOT NULL,
    uuid TEXT UNIQUE,
    vcpu INTEGER NOT NULL DEFAULT 0,         -- vCPU 数量
    vmem INTEGER NOT NULL DEFAULT 0,         -- 内存 (MB)
    vdisk INTEGER NOT NULL DEFAULT 0,        -- 磁盘 (GB)
    os_type TEXT,                            -- OS 类型
    os_version TEXT,                         -- OS 版本
    power_state TEXT DEFAULT 'unknown',      -- 'poweredOn', 'poweredOff', 'suspended'
    ip_address TEXT,
    guest_tools_status TEXT,                 -- VMware Tools 状态
    is_template INTEGER DEFAULT 0,           -- 是否为模板
    annotations TEXT,                        -- 备注信息
    metadata TEXT,                           -- JSON 扩展字段
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (host_id) REFERENCES hosts(id) ON DELETE CASCADE,
    FOREIGN KEY (cluster_id) REFERENCES clusters(id) ON DELETE SET NULL
);

CREATE INDEX idx_vms_host ON vms(host_id);
CREATE INDEX idx_vms_cluster ON vms(cluster_id);
CREATE INDEX idx_vms_power_state ON vms(power_state);
```

#### 2.2.4 metrics - 指标表

```sql
CREATE TABLE metrics (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    entity_type TEXT NOT NULL,               -- 'cluster', 'host', 'vm'
    entity_id TEXT NOT NULL,                 -- 关联实体 ID
    metric_name TEXT NOT NULL,               -- 指标名称
    timestamp INTEGER NOT NULL,              -- Unix timestamp
    value REAL NOT NULL,                     -- 指标值
    unit TEXT,                               -- 单位: '%', 'MB', 'GB', 'count'
    tags TEXT,                               -- JSON 扩展标签
    created_at INTEGER NOT NULL
);

CREATE INDEX idx_metrics_entity ON metrics(entity_type, entity_id);
CREATE INDEX idx_metrics_metric ON metrics(entity_type, entity_id, metric_name, timestamp);
CREATE INDEX idx_metrics_timestamp ON metrics(timestamp);

-- 时序数据分区 (可选，用于数据清理)
-- PRAGMA vacuum_full = ON;  -- 启用 VACUUM 优化
```

#### 2.2.5 connections - 连接配置表

```sql
CREATE TABLE connections (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    type TEXT NOT NULL,                      -- 'vcenter', 'h3c'
    endpoint TEXT NOT NULL,                  -- 服务地址
    port INTEGER,
    username TEXT,
    -- credentials 存储在加密的 credentials 表中
    verify_tls INTEGER DEFAULT 1,            -- 是否验证证书
    status TEXT DEFAULT 'disconnected',      -- 'connected', 'disconnected', 'error'
    last_sync_at INTEGER,
    error_message TEXT,
    metadata TEXT,                           -- JSON 扩展字段
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);

CREATE INDEX idx_connections_type ON connections(type);
CREATE INDEX idx_connections_status ON connections(status);
```

#### 2.2.6 credentials - 凭据表 (加密存储)

```sql
CREATE TABLE credentials (
    id TEXT PRIMARY KEY,
    connection_id TEXT NOT NULL UNIQUE,
    encrypted_data BLOB NOT NULL,            -- AES-256-GCM 加密数据
    nonce BLOB NOT NULL,                     -- 加密 nonce
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (connection_id) REFERENCES connections(id) ON DELETE CASCADE
);
```

#### 2.2.7 tasks - 任务表

```sql
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    type TEXT NOT NULL,                      -- 'collect', 'analyze', 'report'
    connection_id TEXT,
    status TEXT NOT NULL DEFAULT 'pending',  -- 'pending', 'running', 'success', 'failed', 'stopped'
    name TEXT NOT NULL,
    config TEXT,                             -- JSON 配置
    progress REAL DEFAULT 0,                 -- 进度 (0-100)
    current_step TEXT,
    total_steps INTEGER,
    error_message TEXT,
    started_at INTEGER,
    ended_at INTEGER,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (connection_id) REFERENCES connections(id) ON DELETE SET NULL
);

CREATE INDEX idx_tasks_type ON tasks(type);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_connection ON tasks(connection_id);
CREATE INDEX idx_tasks_created ON tasks(created_at DESC);
```

#### 2.2.8 task_logs - 任务日志表

```sql
CREATE TABLE task_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT NOT NULL,
    level TEXT NOT NULL,                     -- 'debug', 'info', 'warn', 'error'
    message TEXT NOT NULL,
    timestamp INTEGER NOT NULL,
    metadata TEXT,                           -- JSON 扩展字段
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
);

CREATE INDEX idx_task_logs_task ON task_logs(task_id);
CREATE INDEX idx_task_logs_timestamp ON task_logs(timestamp DESC);
```

#### 2.2.9 reports - 报告表

```sql
CREATE TABLE reports (
    id TEXT PRIMARY KEY,
    task_id TEXT,
    type TEXT NOT NULL,                      -- 'zombie', 'rightsize', 'tidal', 'health', 'summary'
    entity_type TEXT,                        -- 'cluster', 'host', 'vm'
    entity_id TEXT,
    name TEXT NOT NULL,
    summary TEXT,                            -- 报告摘要
    detail TEXT,                             -- JSON 详细数据
    format TEXT DEFAULT 'json',              -- 'json', 'html', 'pdf'
    file_path TEXT,                          -- 导出文件路径
    status TEXT DEFAULT 'generated',         -- 'generating', 'generated', 'failed'
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE SET NULL
);

CREATE INDEX idx_reports_type ON reports(type);
CREATE INDEX idx_reports_entity ON reports(entity_type, entity_id);
CREATE INDEX idx_reports_created ON reports(created_at DESC);
```

#### 2.2.10 analysis_results - 分析结果表

```sql
CREATE TABLE analysis_results (
    id TEXT PRIMARY KEY,
    report_id TEXT NOT NULL,
    entity_type TEXT NOT NULL,
    entity_id TEXT NOT NULL,
    analysis_type TEXT NOT NULL,             -- 'zombie', 'rightsize', 'tidal', 'health'
    conclusion TEXT NOT NULL,                -- 结论
    confidence REAL,                         -- 置信度 (0-1)
    recommendation TEXT,                     -- 建议
    evidence TEXT,                           -- JSON 证据数据
    savings_estimate TEXT,                   -- JSON 节省估算
    risk_level TEXT,                         -- 'low', 'medium', 'high'
    metadata TEXT,                           -- JSON 扩展字段
    created_at INTEGER NOT NULL,
    FOREIGN KEY (report_id) REFERENCES reports(id) ON DELETE CASCADE
);

CREATE INDEX idx_analysis_results_report ON analysis_results(report_id);
CREATE INDEX idx_analysis_results_entity ON analysis_results(entity_type, entity_id);
CREATE INDEX idx_analysis_results_type ON analysis_results(analysis_type);
```

#### 2.2.11 alerts - 告警表

```sql
CREATE TABLE alerts (
    id TEXT PRIMARY KEY,
    entity_type TEXT NOT NULL,
    entity_id TEXT NOT NULL,
    alert_type TEXT NOT NULL,                -- 'zombie', 'overprovisioned', 'hotspot', etc.
    severity TEXT NOT NULL,                  -- 'info', 'warning', 'critical'
    title TEXT NOT NULL,
    message TEXT,
    is_resolved INTEGER DEFAULT 0,
    is_read INTEGER DEFAULT 0,
    resolved_at INTEGER,
    metadata TEXT,                           -- JSON 扩展字段
    created_at INTEGER NOT NULL
);

CREATE INDEX idx_alerts_entity ON alerts(entity_type, entity_id);
CREATE INDEX idx_alerts_resolved ON alerts(is_resolved);
CREATE INDEX idx_alerts_severity ON alerts(severity);
CREATE INDEX idx_alerts_created ON alerts(created_at DESC);
```

#### 2.2.12 settings - 系统配置表

```sql
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    value_type TEXT NOT NULL DEFAULT 'string', -- 'string', 'int', 'float', 'bool', 'json'
    description TEXT,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);

-- 默认配置
INSERT INTO settings (key, value, value_type, description) VALUES
('data.retention_days', '90', 'int', '数据保留天数'),
('collect.sample_interval', '300', 'int', '采集采样间隔（秒）'),
('collect.max_concurrent', '3', 'int', '最大并发采集任务数'),
('analysis.zombie.cpu_threshold', '5', 'float', '僵尸VM CPU使用率阈值（%）'),
('analysis.zombie.mem_threshold', '10', 'float', '僵尸VM内存使用率阈值（%）'),
('analysis.zombie.duration_days', '14', 'int', '僵尸VM检测持续天数'),
('analysis.rightsize.percentile', '95', 'int', 'Right Size 百分位数'),
('ui.refresh_interval', '5000', 'int', 'UI刷新间隔（毫秒）');
```

## 3. 视图定义

### 3.1 v_host_summary - 主机汇总视图

```sql
CREATE VIEW v_host_summary AS
SELECT
    h.id,
    h.name,
    c.name AS cluster_name,
    h.cpu_total,
    h.mem_total,
    h.disk_total,
    ROUND(h.cpu_used / h.cpu_total * 100, 2) AS cpu_usage_pct,
    ROUND(h.mem_used / h.mem_total * 100, 2) AS mem_usage_pct,
    h.vm_count,
    h.health_score,
    h.status
FROM hosts h
JOIN clusters c ON h.cluster_id = c.id;
```

### 3.2 v_vm_summary - 虚拟机汇总视图

```sql
CREATE VIEW v_vm_summary AS
SELECT
    v.id,
    v.name,
    v.vcpu,
    v.vmem,
    v.vdisk,
    v.power_state,
    v.os_type,
    h.name AS host_name,
    c.name AS cluster_name,
    conn.name AS connection_name
FROM vms v
JOIN hosts h ON v.host_id = h.id
JOIN clusters c ON v.cluster_id = c.id
JOIN connections conn ON h.connection_id = conn.id;
```

### 3.3 v_vm_metrics_latest - 虚拟机最新指标视图

```sql
CREATE VIEW v_vm_metrics_latest AS
SELECT
    m.entity_id AS vm_id,
    m.metric_name,
    m.value,
    m.unit,
    m.timestamp
FROM metrics m
WHERE m.entity_type = 'vm'
  AND m.timestamp = (
    SELECT MAX(timestamp)
    FROM metrics
    WHERE entity_type = 'vm'
      AND entity_id = m.entity_id
      AND metric_name = m.metric_name
);
```

### 3.4 v_task_progress - 任务进度视图

```sql
CREATE VIEW v_task_progress AS
SELECT
    t.id,
    t.name,
    t.type,
    t.status,
    t.progress,
    t.current_step,
    t.total_steps,
    t.started_at,
    t.ended_at,
    ROUND(julianday('now') - julianday(datetime(t.started_at, 'unixepoch')), 2) AS duration_days,
    CASE
        WHEN t.status = 'running' THEN datetime(t.started_at, 'unixepoch')
        WHEN t.ended_at IS NOT NULL THEN datetime(t.ended_at, 'unixepoch')
        ELSE NULL
    END AS last_update
FROM tasks t
WHERE t.status IN ('pending', 'running')
   OR t.created_at > strftime('%s', 'now', '-7 days') * 1;
```

## 4. 索引策略

### 4.1 索引设计原则

- 为外键创建索引
- 为常用查询条件创建复合索引
- 为排序字段创建索引
- 避免过度索引影响写入性能

### 4.2 索引清单

| 表名 | 索引名 | 字段 | 类型 | 用途 |
|------|--------|------|------|------|
| clusters | idx_clusters_vendor | vendor | 单列 | 按供应商查询 |
| clusters | idx_clusters_status | status | 单列 | 按状态筛选 |
| hosts | idx_hosts_cluster | cluster_id | 单列 | 外键索引 |
| hosts | idx_hosts_connection | connection_id | 单列 | 外键索引 |
| hosts | idx_hosts_status | status | 单列 | 按状态筛选 |
| vms | idx_vms_host | host_id | 单列 | 外键索引 |
| vms | idx_vms_cluster | cluster_id | 单列 | 外键索引 |
| vms | idx_vms_power_state | power_state | 单列 | 按电源状态筛选 |
| metrics | idx_metrics_entity | entity_type, entity_id | 复合 | 按实体查询 |
| metrics | idx_metrics_metric | entity_type, entity_id, metric_name, timestamp | 复合 | 时序查询 |
| metrics | idx_metrics_timestamp | timestamp | 单列 | 时间范围查询 |
| tasks | idx_tasks_type | type | 单列 | 按类型筛选 |
| tasks | idx_tasks_status | status | 单列 | 按状态筛选 |
| tasks | idx_tasks_created | created_at DESC | 单列 | 时间排序 |
| reports | idx_reports_type | type | 单列 | 按类型筛选 |
| reports | idx_reports_created | created_at DESC | 单列 | 时间排序 |

## 5. 数据生命周期管理

### 5.1 数据保留策略

| 数据类型 | 保留期限 | 清理策略 |
|----------|----------|----------|
| 指标数据 (metrics) | 可配置，默认 90 天 | 按时间窗口删除 |
| 任务日志 (task_logs) | 30 天 | 按时间删除 |
| 已完成任务 (tasks) | 90 天 | 软删除 |
| 报告文件 (reports) | 用户手动 | 不自动清理 |
| 告警 (alerts) | 180 天 | 软删除 |

### 5.2 清理 SQL 示例

```sql
-- 清理过期指标数据
DELETE FROM metrics
WHERE timestamp < strftime('%s', 'now', '-' || (SELECT value FROM settings WHERE key = 'data.retention_days') || ' days') * 1;

-- 清理过期任务日志
DELETE FROM task_logs
WHERE timestamp < strftime('%s', 'now', '-30 days') * 1;

-- 软删除旧任务
UPDATE tasks
SET status = 'archived'
WHERE ended_at < strftime('%s', 'now', '-90 days') * 1
  AND status IN ('success', 'failed', 'stopped');
```

## 6. 数据迁移

### 6.1 版本管理

```sql
CREATE TABLE schema_migrations (
    version INTEGER PRIMARY KEY,
    description TEXT NOT NULL,
    applied_at INTEGER NOT NULL
);

-- 初始版本
INSERT INTO schema_migrations (version, description, applied_at) VALUES (1, 'Initial schema', strftime('%s', 'now') * 1);
```

### 6.2 迁移脚本示例

```go
// Migration 001: Initial schema
func migrate_001(db *sql.DB) error {
    sql := `
    -- 所有 CREATE TABLE 语句
    `
    _, err := db.Exec(sql)
    return err
}

// Migration 002: Add indexes
func migrate_002(db *sql.DB) error {
    sql := `
    CREATE INDEX IF NOT EXISTS idx_metrics_entity ON metrics(entity_type, entity_id);
    -- ... 其他索引
    `
    _, err := db.Exec(sql)
    return err
}
```

## 7. 性能优化

### 7.1 SQLite 优化配置

```sql
-- 性能优化 PRAGMA
PRAGMA journal_mode = WAL;           -- Write-Ahead Logging
PRAGMA synchronous = NORMAL;         -- 平衡安全与性能
PRAGMA cache_size = -64000;          -- 64MB 缓存
PRAGMA temp_store = MEMORY;          -- 临时表存内存
PRAGMA mmap_size = 30000000000;      -- 启用 mmap
PRAGMA page_size = 4096;             -- 页大小
```

### 7.2 批量写入优化

```go
// 使用事务批量插入
func BatchInsertMetrics(db *sql.DB, metrics []Metric) error {
    tx, _ := db.Begin()
    stmt, _ := tx.Prepare(`
        INSERT INTO metrics (entity_type, entity_id, metric_name, timestamp, value, unit, created_at)
        VALUES (?, ?, ?, ?, ?, ?, ?)
    `)
    defer stmt.Close()

    for _, m := range metrics {
        stmt.Exec(m.EntityType, m.EntityID, m.MetricName, m.Timestamp, m.Value, m.Unit, time.Now().Unix())
    }

    return tx.Commit()
}
```

## 8. 备份与恢复

### 8.1 备份策略

```bash
# SQLite 在线备份
sqlite3 justfit.db ".backup justfit_backup_$(date +%Y%m%d_%H%M%S).db"

# 或使用 Go API
func BackupDatabase(src, dst string) error {
    srcDB, _ := sql.Open("sqlite", src)
    dstDB, _ := sql.Open("sqlite", dst)
    _, err := dstDB.Exec("VACUUM INTO '" + dst + "'")
    return err
}
```

### 8.2 恢复流程

1. 停止应用
2. 替换数据库文件
3. 验证数据库完整性
4. 启动应用

## 9. 数据字典

详细的字段定义请参考 [06-data-dictionary.md](./06-data-dictionary.md)

## 10. 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-07 | 初始版本 | - |
