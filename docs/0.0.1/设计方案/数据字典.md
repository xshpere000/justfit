# JustFit 数据字典

## 0. 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 数据字典 |
| 版本 | v1.0 |
| 日期 | 2026-02-07 |
| 项目版本 | v0.0.1 Beta |

## 1. 实体关系

```
connections (连接配置)
    │
    ├───── 1:N ─────→ clusters (集群)
    │                       │
    │                   ┌─── 1:N ──→ hosts (主机)
    │                   │               │
    │                   │            ── 1:N ──→ vms (虚拟机)
    │                   │               │
    │                   │            ── 1:N ──→ metrics (指标)
    │                   │
    │                   └────── 1:N ───────────────→ metrics
    │
    ├───── 1:N ─────→ tasks (任务)
    │                       │
    │                   ┌─── 1:N ──→ task_logs (任务日志)
    │                   │
    │                   └────── 1:N ──→ reports (报告)
    │                                       │
    │                                   ── 1:N ──→ analysis_results (分析结果)
    │
    └───── 1:N ─────→ alerts (告警)
                                ↑
                            ─── N:1 ───
                                │
                    clusters / hosts / vms
```

## 2. 字段定义

### 2.1 connections - 连接配置表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键 |
| name | TEXT | 100 | Y | - | 连接名称 |
| type | TEXT | 20 | Y | - | vcenter, h3c |
| endpoint | TEXT | 255 | Y | - | 服务器地址 |
| port | INTEGER | - | N | - | 端口号 |
| username | TEXT | 100 | N | - | 用户名 |
| verify_tls | INTEGER | 1 | N | 1 | 是否验证证书 1=是 0=否 |
| status | TEXT | 20 | N | disconnected | connected, disconnected, error |
| last_sync_at | INTEGER | - | N | - | 最后同步时间 (Unix timestamp) |
| error_message | TEXT | - | N | - | 错误信息 |
| metadata | TEXT | - | N | - | JSON 扩展字段 |
| created_at | INTEGER | - | Y | - | 创建时间 (Unix timestamp) |
| updated_at | INTEGER | - | Y | - | 更新时间 (Unix timestamp) |

### 2.2 credentials - 凭据表 (加密)

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键 |
| connection_id | TEXT | 36 | Y | - | 关联 connections.id |
| encrypted_data | BLOB | - | Y | - | AES-256-GCM 加密数据 |
| nonce | BLOB | 12 | Y | - | 加密 nonce |
| created_at | INTEGER | - | Y | - | 创建时间 |
| updated_at | INTEGER | - | Y | - | 更新时间 |

### 2.3 clusters - 集群表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键，平台集群 ID |
| name | TEXT | 200 | Y | - | 集群名称 |
| vendor | TEXT | 20 | Y | - | vcenter, h3c |
| region | TEXT | 100 | N | - | 区域/机房 |
| datacenter | TEXT | 100 | N | - | 数据中心名称 |
| total_cpu | INTEGER | - | Y | 0 | 总 CPU 核数 |
| total_mem | INTEGER | - | Y | 0 | 总内存 (MB) |
| total_disk | INTEGER | - | Y | 0 | 总磁盘 (GB) |
| used_cpu | REAL | - | N | 0 | 已用 CPU 核数 |
| used_mem | REAL | - | N | 0 | 已用内存 (MB) |
| used_disk | REAL | - | N | 0 | 已用磁盘 (GB) |
| health_score | REAL | - | N | - | 健康评分 (0-100) |
| status | TEXT | 20 | N | active | active, inactive, error |
| metadata | TEXT | - | N | - | JSON 扩展字段 |
| created_at | INTEGER | - | Y | - | 创建时间 |
| updated_at | INTEGER | - | Y | - | 更新时间 |

### 2.4 hosts - 主机表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键，平台主机 ID |
| cluster_id | TEXT | 36 | Y | - | 关联 clusters.id |
| connection_id | TEXT | 36 | Y | - | 关联 connections.id |
| name | TEXT | 200 | Y | - | 主机名称 |
| ip_address | TEXT | 50 | N | - | IP 地址 |
| cpu_total | INTEGER | - | Y | 0 | CPU 核数 |
| mem_total | INTEGER | - | Y | 0 | 内存 (MB) |
| disk_total | INTEGER | - | Y | 0 | 磁盘 (GB) |
| cpu_used | REAL | - | N | 0 | 已用 CPU 核数 |
| mem_used | REAL | - | N | 0 | 已用内存 (MB) |
| disk_used | REAL | - | N | 0 | 已用磁盘 (GB) |
| vm_count | INTEGER | - | N | 0 | 虚拟机数量 |
| health_score | REAL | - | N | - | 健康评分 (0-100) |
| status | TEXT | 20 | N | active | active, maintenance, error |
| metadata | TEXT | - | N | - | JSON 扩展字段 |
| created_at | INTEGER | - | Y | - | 创建时间 |
| updated_at | INTEGER | - | Y | - | 更新时间 |

### 2.5 vms - 虚拟机表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键，平台 VM ID |
| host_id | TEXT | 36 | Y | - | 关联 hosts.id |
| cluster_id | TEXT | 36 | N | - | 关联 clusters.id |
| name | TEXT | 200 | Y | - | 虚拟机名称 |
| uuid | TEXT | 36 | N | - | 平台 UUID |
| vcpu | INTEGER | - | Y | 0 | vCPU 数量 |
| vmem | INTEGER | - | Y | 0 | 内存 (MB) |
| vdisk | INTEGER | - | Y | 0 | 磁盘 (GB) |
| os_type | TEXT | 50 | N | - | OS 类型 |
| os_version | TEXT | 50 | N | - | OS 版本 |
| power_state | TEXT | 20 | N | unknown | poweredOn, poweredOff, suspended |
| ip_address | TEXT | 50 | N | - | IP 地址 |
| guest_tools_status | TEXT | 20 | N | - | VMware Tools 状态 |
| is_template | INTEGER | 1 | N | 0 | 是否为模板 1=是 0=否 |
| annotations | TEXT | - | N | - | 备注信息 |
| metadata | TEXT | - | N | - | JSON 扩展字段 |
| created_at | INTEGER | - | Y | - | 创建时间 |
| updated_at | INTEGER | - | Y | - | 更新时间 |

### 2.6 metrics - 指标表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | Y | AUTO | 自增主键 |
| entity_type | TEXT | 20 | Y | - | cluster, host, vm |
| entity_id | TEXT | 36 | Y | - | 关联实体 ID |
| metric_name | TEXT | 50 | Y | - | 指标名称 |
| timestamp | INTEGER | - | Y | - | Unix timestamp |
| value | REAL | - | Y | - | 指标值 |
| unit | TEXT | 20 | N | - | 单位: %, MB, GB, count |
| tags | TEXT | - | N | - | JSON 扩展标签 |
| created_at | INTEGER | - | Y | - | 入库时间 |

### 2.7 tasks - 任务表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键 |
| type | TEXT | 20 | Y | - | collect, analyze, report |
| connection_id | TEXT | 36 | N | - | 关联 connections.id |
| status | TEXT | 20 | Y | pending | pending, running, success, failed, stopped |
| name | TEXT | 200 | Y | - | 任务名称 |
| config | TEXT | - | N | - | JSON 配置 |
| progress | REAL | - | N | 0 | 进度 (0-100) |
| current_step | TEXT | 100 | N | - | 当前步骤描述 |
| total_steps | INTEGER | - | N | - | 总步骤数 |
| error_message | TEXT | - | N | - | 错误信息 |
| started_at | INTEGER | - | N | - | 开始时间 |
| ended_at | INTEGER | - | N | - | 结束时间 |
| created_at | INTEGER | - | Y | - | 创建时间 |
| updated_at | INTEGER | - | Y | - | 更新时间 |

### 2.8 task_logs - 任务日志表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | INTEGER | - | Y | AUTO | 自增主键 |
| task_id | TEXT | 36 | Y | - | 关联 tasks.id |
| level | TEXT | 10 | Y | - | debug, info, warn, error |
| message | TEXT | - | Y | - | 日志消息 |
| timestamp | INTEGER | - | Y | - | Unix timestamp |
| metadata | TEXT | - | N | - | JSON 扩展字段 |

### 2.9 reports - 报告表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键 |
| task_id | TEXT | 36 | N | - | 关联 tasks.id |
| type | TEXT | 20 | Y | - | zombie, rightsize, tidal, health, summary |
| entity_type | TEXT | 20 | N | - | cluster, host, vm |
| entity_id | TEXT | 36 | N | - | 关联实体 ID |
| name | TEXT | 200 | Y | - | 报告名称 |
| summary | TEXT | - | N | - | 报告摘要 |
| detail | TEXT | - | N | - | JSON 详细数据 |
| format | TEXT | 10 | N | json | json, html, pdf |
| file_path | TEXT | 500 | N | - | 导出文件路径 |
| status | TEXT | 20 | N | generated | generating, generated, failed |
| created_at | INTEGER | - | Y | - | 创建时间 |
| updated_at | INTEGER | - | Y | - | 更新时间 |

### 2.10 analysis_results - 分析结果表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键 |
| report_id | TEXT | 36 | Y | - | 关联 reports.id |
| entity_type | TEXT | 20 | Y | - | cluster, host, vm |
| entity_id | TEXT | 36 | Y | - | 关联实体 ID |
| analysis_type | TEXT | 20 | Y | - | zombie, rightsize, tidal, health |
| conclusion | TEXT | - | Y | - | 结论 |
| confidence | REAL | - | N | - | 置信度 (0-1) |
| recommendation | TEXT | - | N | - | 建议 |
| evidence | TEXT | - | N | - | JSON 证据数据 |
| savings_estimate | TEXT | - | N | - | JSON 节省估算 |
| risk_level | TEXT | 10 | N | - | low, medium, high |
| metadata | TEXT | - | N | - | JSON 扩展字段 |
| created_at | INTEGER | - | Y | - | 创建时间 |

### 2.11 alerts - 告警表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | TEXT | 36 | Y | - | UUID 主键 |
| entity_type | TEXT | 20 | Y | - | cluster, host, vm |
| entity_id | TEXT | 36 | Y | - | 关联实体 ID |
| alert_type | TEXT | 30 | Y | - | zombie, overprovisioned, hotspot, etc. |
| severity | TEXT | 10 | Y | - | info, warning, critical |
| title | TEXT | 200 | Y | - | 告警标题 |
| message | TEXT | - | N | - | 告警消息 |
| is_resolved | INTEGER | 1 | N | 0 | 是否已解决 1=是 0=否 |
| is_read | INTEGER | 1 | N | 0 | 是否已读 1=是 0=否 |
| resolved_at | INTEGER | - | N | - | 解决时间 |
| metadata | TEXT | - | N | - | JSON 扩展字段 |
| created_at | INTEGER | - | Y | - | 创建时间 |

### 2.12 settings - 系统配置表

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| key | TEXT | 100 | Y | - | 配置键 |
| value | TEXT | - | Y | - | 配置值 (字符串形式) |
| value_type | TEXT | 20 | Y | string | string, int, float, bool, json |
| description | TEXT | - | N | - | 配置说明 |
| created_at | INTEGER | - | Y | - | 创建时间 |
| updated_at | INTEGER | - | Y | - | 更新时间 |

## 3. 指标字典

### 3.1 CPU 指标

| 指标名称 | metric_name | 单位 | 说明 | 聚合方式 |
|----------|-------------|------|------|----------|
| CPU 使用率 | cpu.usage_pct | % | CPU 使用百分比 | avg, max, p95 |
| CPU 就绪时间 | cpu.ready_ms | ms | CPU ready 时间 | avg, max |
| CPU 等待时间 | cpu.wait_ms | ms | CPU 等待时间 | avg, max |
| CPU 核心数 | cpu.count | count | CPU 核心数 | last |

### 3.2 内存指标

| 指标名称 | metric_name | 单位 | 说明 | 聚合方式 |
|----------|-------------|------|------|----------|
| 内存使用率 | mem.usage_pct | % | 内存使用百分比 | avg, max, p95 |
| 活跃内存 | mem.active_mb | MB | 活跃内存量 | avg, max |
| 内存交换 | mem.swap_mb | MB | 交换内存量 | avg, max |
| 内存压缩 | mem.compressed_mb | MB | 压缩内存量 | avg, max |
| 内存 ballooning | mem.balloon_mb | MB | Ballooning 内存 | avg, max |

### 3.3 磁盘指标

| 指标名称 | metric_name | 单位 | 说明 | 聚合方式 |
|----------|-------------|------|------|----------|
| 磁盘读 IOPS | disk.read_iops | count/s | 磁盘读 IOPS | avg, max |
| 磁盘写 IOPS | disk.write_iops | count/s | 磁盘写 IOPS | avg, max |
| 磁盘读吞吐 | disk.read_throughput_mb | MB/s | 磁盘读吞吐量 | avg, max |
| 磁盘写吞吐 | disk.write_throughput_mb | MB/s | 磁盘写吞吐量 | avg, max |
| 磁盘延迟 | disk.latency_ms | ms | 磁盘 IO 延迟 | avg, max |
| 磁盘使用率 | disk.usage_pct | % | 磁盘使用百分比 | avg, max |

### 3.4 网络指标

| 指标名称 | metric_name | 单位 | 说明 | 聚合方式 |
|----------|-------------|------|------|----------|
| 网络入站流量 | net.in_mb | MB/s | 入站流量 | avg, max |
| 网络出站流量 | net.out_mb | MB/s | 出站流量 | avg, max |
| 网络入站包率 | net.in_packets | count/s | 入站包速率 | avg, max |
| 网络出站包率 | net.out_packets | count/s | 出站包速率 | avg, max |

### 3.5 系统指标

| 指标名称 | metric_name | 单位 | 说明 | 聚合方式 |
|----------|-------------|------|------|----------|
| 运行时间 | sys.uptime_sec | sec | 系统运行时间 | last |
| 心跳状态 | sys.heartbeat | bool | 心跳状态 | last |

## 4. 枚举值定义

### 4.1 连接类型 (connections.type)

| 值 | 说明 |
|----|------|
| vcenter | VMware vCenter |
| h3c | H3C UIS |

### 4.2 连接状态 (connections.status)

| 值 | 说明 |
|----|------|
| connected | 已连接 |
| disconnected | 未连接 |
| error | 连接错误 |

### 4.3 集群状态 (clusters.status)

| 值 | 说明 |
|----|------|
| active | 活跃 |
| inactive | 非活跃 |
| error | 错误 |

### 4.4 主机状态 (hosts.status)

| 值 | 说明 |
|----|------|
| active | 活跃 |
| maintenance | 维护中 |
| error | 错误 |

### 4.5 虚拟机电源状态 (vms.power_state)

| 值 | 说明 |
|----|------|
| poweredOn | 开机 |
| poweredOff | 关机 |
| suspended | 暂停 |

### 4.6 任务类型 (tasks.type)

| 值 | 说明 |
|----|------|
| collect | 数据采集 |
| analyze | 数据分析 |
| report | 报告生成 |

### 4.7 任务状态 (tasks.status)

| 值 | 说明 |
|----|------|
| pending | 等待中 |
| running | 运行中 |
| success | 成功 |
| failed | 失败 |
| stopped | 已停止 |

### 4.8 分析类型 (analysis_results.analysis_type)

| 值 | 说明 |
|----|------|
| zombie | 僵尸 VM 检测 |
| rightsize | 资源配置评估 |
| tidal | 潮汐检测 |
| health | 健康评分 |

### 4.9 风险等级 (analysis_results.risk_level)

| 值 | 说明 |
|----|------|
| low | 低风险 |
| medium | 中风险 |
| high | 高风险 |

### 4.10 告警严重度 (alerts.severity)

| 值 | 说明 |
|----|------|
| info | 信息 |
| warning | 警告 |
| critical | 严重 |

### 4.11 报告类型 (reports.type)

| 值 | 说明 |
|----|------|
| zombie | 僵尸 VM 报告 |
| rightsize | Right Size 报告 |
| tidal | 潮汐检测报告 |
| health | 健康评分报告 |
| summary | 综合报告 |

### 4.12 报告格式 (reports.format)

| 值 | 说明 |
|----|------|
| json | JSON 格式 |
| html | HTML 格式 |
| pdf | PDF 格式 |

### 4.13 配置值类型 (settings.value_type)

| 值 | 说明 |
|----|------|
| string | 字符串 |
| int | 整数 |
| float | 浮点数 |
| bool | 布尔值 |
| json | JSON 对象 |

## 5. JSON 结构定义

### 5.1 connections.metadata

```json
{
  "api_version": "7.0.3",
  "server_time": "2026-02-07T00:00:00Z",
  "custom_fields": {}
}
```

### 5.2 analysis_results.evidence (僵尸 VM)

```json
{
  "duration_days": 14,
  "detection_window": {
    "start": "2026-01-24T00:00:00Z",
    "end": "2026-02-07T00:00:00Z"
  },
  "cpu": {
    "mean": 2.5,
    "p95": 4.2,
    "max": 8.1,
    "unit": "%"
  },
  "memory": {
    "mean": 15.3,
    "p95": 18.7,
    "max": 25.4,
    "unit": "%"
  },
  "disk_io": {
    "iops_mean": 5.2,
    "throughput_mean_mb": 0.1
  },
  "network": {
    "in_mb_mean": 0.01,
    "out_mb_mean": 0.01
  }
}
```

### 5.3 analysis_results.evidence (Right Size)

```json
{
  "analysis_period_days": 30,
  "percentile": 95,
  "current_config": {
    "vcpu": 4,
    "mem_mb": 8192
  },
  "recommended_config": {
    "vcpu": 2,
    "mem_mb": 4096
  },
  "utilization": {
    "cpu": {
      "p95": 35.2,
      "max": 78.5,
      "unit": "%"
    },
    "memory": {
      "p95": 42.8,
      "max": 85.3,
      "unit": "%"
    }
  },
  "savings": {
    "vcpu": 2,
    "mem_mb": 4096,
    "percentage": 50
  },
  "risk_assessment": {
    "level": "low",
    "buffer": 20,
    "notes": "建议配置留有 20% 缓冲"
  }
}
```

### 5.4 analysis_results.evidence (潮汐检测)

```json
{
  "analysis_period_days": 30,
  "cycle_type": "daily",
  "stability_score": 0.85,
  "peak_hours": [9, 10, 11, 14, 15, 16],
  "off_peak_hours": [0, 1, 2, 3, 4, 5, 6, 20, 21, 22, 23],
  "peak_difference": {
    "cpu": 65.2,
    "memory": 45.8,
    "unit": "%"
  },
  "schedule_recommendation": {
    "stop_time": "20:00",
    "start_time": "08:00",
    "timezone": "Asia/Shanghai"
  },
  "estimated_savings": {
    "hours_per_day": 12,
    "energy_percentage": 50
  }
}
```

### 5.5 analysis_results.evidence (健康评分)

```json
{
  "overall_score": 78.5,
  "dimensions": {
    "resource_balance": 82.3,
    "overcommit_risk": 75.0,
    "hotspot_concentration": 68.5
  },
  "hotspots": [
    {
      "host_id": "host-123",
      "host_name": "esxi-01",
      "issues": ["CPU 使用率高", "内存接近上限"]
    }
  ],
  "recommendations": [
    "将高负载 VM 迁移到空闲主机",
    "评估内存超配策略"
  ]
}
```

## 6. 数据质量规则

### 6.1 必填字段检查

| 表名 | 必填字段 |
|------|----------|
| connections | id, name, type, endpoint |
| clusters | id, name, vendor, total_cpu, total_mem, total_disk |
| hosts | id, cluster_id, connection_id, name, cpu_total, mem_total, disk_total |
| vms | id, host_id, name, vcpu, vmem, vdisk |
| metrics | entity_type, entity_id, metric_name, timestamp, value |
| tasks | id, type, status, name |
| alerts | id, entity_type, entity_id, alert_type, severity, title |

### 6.2 数据范围约束

| 字段 | 约束 |
|------|------|
| health_score | 0-100 |
| progress | 0-100 |
| confidence | 0-1 |
| timestamp | 合理时间范围，非未来时间 |
| percentage 类型指标 | 0-100 |

### 6.3 引用完整性

- hosts.cluster_id 必须存在于 clusters
- vms.host_id 必须存在于 hosts
- vms.cluster_id 必须存在于 clusters
- metrics.entity_id 根据 entity_type 必须存在对应实体
- tasks.connection_id 必须存在于 connections

## 7. 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-07 | 初始版本 | - |
