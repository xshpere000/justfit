# JustFit 架构设计文档

## 0. 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 架构设计文档 |
| 版本 | v1.0 |
| 日期 | 2026-02-07 |
| 项目版本 | v0.0.1 Beta |

## 1. 架构概述

### 1.1 架构目标

- 支撑多平台采集与统一治理
- 便于算法迭代与扩展
- 适配多 OS 多架构
- 在资源可控的前提下支持持续采集
- 模块化设计，易于维护和测试

### 1.2 架构原则

| 原则 | 说明 |
|------|------|
| 关注点分离 | 各层职责明确，避免跨层调用 |
| 接口隔离 | 模块间通过定义良好的接口通信 |
| 依赖倒置 | 高层模块不依赖低层模块，都依赖抽象 |
| 开闭原则 | 对扩展开放，对修改关闭 |
| 单一职责 | 每个模块只负责一个功能领域 |

## 2. 系统架构

### 2.1 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Presentation Layer                     │
│                   (Vue 3 + Element Plus)                    │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────┐ │
│  │Dashboard │ │Analysis  │ │ Reports  │ │ Settings & Tasks │ │
│  └──────────┘ └──────────┘ └──────────┘ └──────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       Application Layer                     │
│                         (Wails v2)                          │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌───────────┐ │
│  │ Connection │ │   Task     │ │  Analysis  │ │  Report   │ │
│  │  Service   │ │  Service   │ │  Service   │ │  Service  │ │
│  └────────────┘ └────────────┘ └────────────┘ └───────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        Domain Layer                         │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌───────────┐ │
│  │ Connector  │ │    ETL     │ │  Analyzer  │ │ Scheduler │ │
│  │  Manager   │ │  Pipeline  │ │  Engine    │ │           │ │
│  └────────────┘ └────────────┘ └────────────┘ └───────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Infrastructure Layer                      │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌───────────┐ │
│  │  Storage   │ │    Log     │ │   Config   │ │  Security │ │
│  │ (SQLite)   │ │  Manager   │ │  Manager   │ │  Manager  │ │
│  └────────────┘ └────────────┘ └────────────┘ └───────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

| 模块 | 职责 | 技术选型 |
|------|------|----------|
| Presentation Layer | 用户界面展示与交互 | Vue 3 + Vite + Element Plus + ECharts |
| Application Layer | 业务逻辑编排与 Wails 绑定 | Go 1.21+ + Wails v2 |
| Domain Layer | 核心业务逻辑实现 | Go |
| Infrastructure Layer | 基础设施服务 | Go (SQLite, 加密库等) |

## 3. 核心模块设计

### 3.1 采集层 (Connector)

```
┌─────────────────────────────────────────────────────────┐
│                    Connector Manager                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌────────────────────┐      ┌─────────────────────┐   │
│  │  Connector Interface│      │  Connection Config   │   │
│  │  - Connect()        │◄─────│  - Endpoint          │   │
│  │  - Test()           │      │  - Credentials       │   │
│  │  - Collect()        │      │  - Options           │   │
│  │  - Disconnect()     │      └─────────────────────┘   │
│  └────────────────────┘                                 │
│            ▲                                             │
│            │ implements                                  │
│  ┌─────────┴─────────────────────────────────────────┐  │
│  │                                                    │  │
│  │  ┌──────────────┐       ┌──────────────┐         │  │
│  │  │ vCenter      │       │ H3C UIS      │         │  │
│  │  │ Connector    │       │ Connector    │         │  │
│  │  │ (govmomi)    │       │ (HTTP API)   │         │  │
│  │  └──────────────┘       └──────────────┘         │  │
│  │                                                    │  │
│  └────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

**接口定义：**

```go
// Connector 采集器接口
type Connector interface {
    // Connect 建立连接
    Connect(ctx context.Context, config *ConnectionConfig) error

    // Test 测试连接
    Test(ctx context.Context) error

    // Collect 采集数据
    Collect(ctx context.Context, scope *CollectScope) (*CollectResult, error)

    // Disconnect 断开连接
    Disconnect(ctx context.Context) error

    // GetMetadata 获取平台元数据
    GetMetadata(ctx context.Context) (*PlatformMetadata, error)
}
```

### 3.2 数据治理层 (ETL)

```
┌─────────────────────────────────────────────────────────┐
│                      ETL Pipeline                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │ Extract  │───►│Transform │───►│  Load    │         │
│  │          │    │          │    │          │         │
│  │ - 原始   │    │ - 校验   │    │ - SQLite │         │
│  │   数据   │    │ - 清洗   │    │   写入   │         │
│  │ - JSON   │    │ - 归一   │    │ - 批量   │         │
│  └──────────┘    └──────────┘    └──────────┘         │
│       │               │               │                │
│       ▼               ▼               ▼                │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐         │
│  │ Raw Data │    │ Clean    │    │ Database │         │
│  │  Buffer  │    │  Data    │    │          │         │
│  └──────────┘    └──────────┘    └──────────┘         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**处理流程：**

1. **Extract**: 从 Connector 获取原始数据
2. **Transform**: 数据校验、清洗、归一化
3. **Load**: 批量写入 SQLite 数据库

### 3.3 算法层 (Analyzer)

```
┌─────────────────────────────────────────────────────────┐
│                    Analyzer Engine                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   Zombie     │  │  Right Size  │  │    Tidal     │ │
│  │   Detector   │  │   Evaluator  │  │   Detector   │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │    Health    │  │   Metrics    │  │    Rule      │ │
│  │   Scorer     │  │  Calculator  │  │    Engine    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                         │
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  AnalysisResult │
                    └─────────────────┘
```

**算法接口：**

```go
// Analyzer 分析器接口
type Analyzer interface {
    // Name 分析器名称
    Name() string

    // Type 分析类型
    Type() AnalysisType

    // Analyze 执行分析
    Analyze(ctx context.Context, input *AnalysisInput) (*AnalysisResult, error)

    // Validate 验证输入参数
    Validate(input *AnalysisInput) error
}
```

### 3.4 报告层 (Report)

```
┌─────────────────────────────────────────────────────────┐
│                     Report Engine                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │               Report Generator                  │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐         │   │
│  │  │ Summary │  │ Details │  │ Charts  │         │   │
│  │  │ Section │  │ Section │  │ Section │         │   │
│  │  └─────────┘  └─────────┘  └─────────┘         │   │
│  └─────────────────────────────────────────────────┘   │
│                         │                               │
│                         ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │               Export Manager                    │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐         │   │
│  │  │   PDF   │  │  HTML   │  │  JSON   │         │   │
│  │  │Exporter │  │Exporter │  │Exporter │         │   │
│  │  └─────────┘  └─────────┘  └─────────┘         │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 3.5 任务调度层 (Scheduler)

```
┌─────────────────────────────────────────────────────────┐
│                    Task Scheduler                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                  Task Queue                     │   │
│  │  ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐       │   │
│  │  │Task1│ │Task2│ │Task3│ │Task4│ │Task5│...    │   │
│  │  └─────┘ └─────┘ └─────┘ └─────┘ └─────┘       │   │
│  └─────────────────────────────────────────────────┘   │
│                          │                               │
│                          ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Worker Pool (Max: N)               │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐         │   │
│  │  │ Worker1 │  │ Worker2 │  │ Worker3 │ ...     │   │
│  │  └─────────┘  └─────────┘  └─────────┘         │   │
│  └─────────────────────────────────────────────────┘   │
│                          │                               │
│                          ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Task State Manager                 │   │
│  │  Pending → Running → Success/Failed             │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**任务状态机：**

```
                    ┌──────────┐
                    │  Pending │
                    └─────┬────┘
                          │ Start
                          ▼
                    ┌──────────┐
              ┌─────│ Running  │─────┐
              │     └─────┬────┘     │
              │           │          │
        Stop │           │ Complete │
              │           │          │
              ▼           ▼          ▼
        ┌──────────┐ ┌──────────┐ ┌──────────┐
        │ Stopped  │ │ Success  │ │  Failed  │
        └──────────┘ └──────────┘ └─────┬────┘
                                           │
                                           │ Retry
                                           ▼
                                      ┌──────────┐
                                      │  Pending │
                                      └──────────┘
```

## 4. 数据流设计

### 4.1 采集数据流

```
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ vCenter │───►│Connector│───►│   ETL   │───►│ Storage │
│  API    │    │         │    │Pipeline │    │ (SQLite)│
└─────────┘    └─────────┘    └─────────┘    └─────────┘
                                          │
                                          ▼
                                   ┌─────────┐
                                   │ Analyzer│
                                   └─────────┘
                                          │
                                          ▼
                                   ┌─────────┐
                                   │ Report  │
                                   └─────────┘
```

### 4.2 数据模型流转

```
┌─────────────────────────────────────────────────────────┐
│                    Raw Data (JSON)                      │
│  ┌─────────────────────────────────────────────────┐   │
│  │ {                                               │   │
│  │   "clusters": [...],                            │   │
│  │   "hosts": [...],                               │   │
│  │   "vms": [...],                                 │   │
│  │   "metrics": [...]                              │   │
│  │ }                                               │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │ ETL
                          ▼
┌────────────────────────────────────────────────────────┐
│                  Unified Data Model                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │ {                                               │   │
│  │   "entity_type": "vm",                          │   │
│  │   "entity_id": "vm-123",                        │   │
│  │   "metrics": {                                  │   │
│  │     "cpu_usage_pct": [...],                     │   │
│  │     "mem_usage_pct": [...]                      │   │
│  │   }                                             │   │
│  │ }                                               │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │ Load
                          ▼
┌─────────────────────────────────────────────────────────┐
│                    SQLite Schema                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │ clusters, hosts, vms, metrics, reports, tasks   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## 5. Wails 应用架构

### 5.1 目录结构

```
justfit/
├── frontend/                 # Vue 3 前端
│   ├── src/
│   │   ├── api/             # API 服务层
│   │   ├── components/      # 通用组件
│   │   ├── views/           # 页面组件
│   │   ├── stores/          # Pinia 状态管理
│   │   ├── router/          # 路由配置
│   │   ├── utils/           # 工具函数
│   │   └── App.vue
│   ├── package.json
│   └── vite.config.js
├── backend/                  # Go 后端
│   ├── app.go               # Wails 入口
│   ├── config/              # 配置管理
│   ├── connector/           # 采集连接器
│   ├── etl/                 # 数据治理
│   ├── storage/             # 存储层
│   ├── analyzer/            # 分析算法
│   ├── report/              # 报告生成
│   ├── task/                # 任务调度
│   ├── log/                 # 日志管理
│   └── models/              # 数据模型
├── wails.json               # Wails 配置
└── main.go                  # 主入口
```

### 5.2 Wails 绑定结构

```
┌─────────────────────────────────────────────────────────┐
│                    Frontend (Vue 3)                      │
│  ┌─────────────────────────────────────────────────┐   │
│  │           api/ (Generated by Wails)             │   │
│  │  ┌─────────────────────────────────────────┐    │   │
│  │  │ export const Connection = {              │    │   │
│  │  │   CreateConnection,                      │    │   │
│  │  │   ListConnections,                       │    │   │
│  │  │   TestConnection,                        │    │   │
│  │  │   DeleteConnection                       │    │   │
│  │  │ }                                        │    │   │
│  │  └─────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                          │ IPC
                          │
┌─────────────────────────────────────────────────────────┐
│                     Backend (Go)                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │           Services (Exported by Wails)          │   │
│  │  ┌─────────────────────────────────────────┐    │   │
│  │  │ type ConnectionService struct {          │    │   │
│  │  │   // ...                                │    │   │
│  │  │ }                                        │    │   │
│  │  │                                          │    │   │
│  │  │ func (s *ConnectionService)              │    │   │
│  │  │   CreateConnection(...) error {          │    │   │
│  │  │   // ...                                │    │   │
│  │  │ }                                        │    │   │
│  │  └─────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## 6. 安全架构

### 6.1 凭据管理

```
┌─────────────────────────────────────────────────────────┐
│                   Credential Manager                    │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Encryption Layer                   │   │
│  │  ┌─────────────────────────────────────────┐    │   │
│  │  │  Algorithm: AES-256-GCM                 │    │   │
│  │  │  Key: Derived from machine ID + salt    │    │   │
│  │  └─────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────┘   │
│                          │                               │
│                          ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │              Storage Layer                      │   │
│  │  Location: $APP_DATA/credentials.db            │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 6.2 日志脱敏

```go
// 敏感字段脱敏规则
type SensitiveFields struct {
    Password    string // 隐藏
    Token       string // 隐藏
    Secret      string // 隐藏
    APIKey      string // 隐藏
    Endpoint    string // 部分隐藏
}
```

## 7. 可扩展性设计

### 7.1 采集层扩展

```go
// 注册新平台的 Connector
func RegisterConnector(platformType string, factory ConnectorFactory) {
    connectorRegistry.Register(platformType, factory)
}

// 使用示例
RegisterConnector("vcenter", func() Connector {
    return &VCenterConnector{}
})

RegisterConnector("h3c", func() Connector {
    return &H3CConnector{}
})
```

### 7.2 算法层扩展

```go
// 注册新的 Analyzer
func RegisterAnalyzer(analyzerType string, factory AnalyzerFactory) {
    analyzerRegistry.Register(analyzerType, factory)
}

// 使用示例
RegisterAnalyzer("zombie", func() Analyzer {
    return &ZombieAnalyzer{}
})

RegisterAnalyzer("custom", func() Analyzer {
    return &CustomAnalyzer{} // 用户自定义
})
```

## 8. 技术选型

### 8.1 技术栈

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| 前端框架 | Vue 3 | Composition API, 响应式系统 |
| 构建工具 | Vite | 快速开发, HMR |
| UI 组件库 | Element Plus | 企业级组件库 |
| 图表库 | ECharts | 丰富的图表类型 |
| 状态管理 | Pinia | Vue 3 官方推荐 |
| 后端语言 | Go 1.21+ | 高性能, 简洁并发 |
| 桌面框架 | Wails v2 | Go + Web 技术 |
| vCenter SDK | govmomi | VMware 官方 SDK |
| 数据库 | SQLite | 嵌入式, 零配置 |
| 加密库 | crypto/aes | 标准库 |

### 8.2 选型理由

| 技术 | 选型理由 |
|------|----------|
| Wails v2 | 跨平台支持, 原生性能, 前后端分离 |
| Vue 3 | 学习曲线平缓, 生态成熟, TypeScript 支持好 |
| Element Plus | 组件丰富, 中文文档, 企业应用广泛 |
| SQLite | 零配置, 单文件存储, 适合桌面应用 |
| Go | 编译产物小, 跨平台编译简单, 并发模型优秀 |

## 9. 部署架构

### 9.1 单机部署

```
┌─────────────────────────────────────────────────────────┐
│                  JustFit Desktop App                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │            Application Process                  │   │
│  │  ┌─────────┐         ┌─────────────────────┐    │   │
│  │  │  Front  │  IPC    │       Back          │    │   │
│  │  │  (Vue)  │◄───────►│       (Go)          │    │   │
│  │  └─────────┘         └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────┘   │
│                         │                               │
│                         ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │            Local Storage                         │   │
│  │  - $APP_DATA/justfit.db                         │   │
│  │  - $APP_DATA/credentials.db                     │   │
│  │  - $APP_DATA/logs/                              │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 9.2 多平台支持

| 平台 | 架构 | 打包方式 | 签名 |
|------|------|----------|------|
| Windows | x86_64 | NSIS installer | 代码签名证书 |
| 麒麟 V10 | x86_64/loongarch64 | AppImage/deb | GPG 签名 |
| 统信 UOS | x86_64/loongarch64 | AppImage/deb | GPG 签名 |
| macOS | x86_64/arm64 | DMG/App Bundle | Apple Developer |

## 10. 性能考虑

### 10.1 性能优化策略

| 场景 | 策略 |
|------|------|
| 大规模 VM 采集 | 分批并行采集, 流式处理 |
| 指标数据存储 | 批量写入, 索引优化 |
| 前端列表渲染 | 虚拟滚动, 分页加载 |
| 图表渲染 | 数据抽样, 按需加载 |
| 任务并发 | 可配置 Worker 池大小 |

### 10.2 资源限制

| 资源 | 限制 |
|------|------|
| 内存使用 | < 500MB (空闲), < 2GB (采集中) |
| 磁盘占用 | < 100MB (程序), 可配置数据保留策略 |
| CPU 占用 | < 10% (空闲), < 50% (采集中) |
| 网络带宽 | 根据采集规模自适应 |

## 11. 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-07 | 初始版本 | - |
