# JustFit 测试计划文档

## 0. 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 测试计划文档 |
| 版本 | v1.0 |
| 日期 | 2026-02-07 |
| 项目版本 | v0.0.1 Beta |

## 1. 测试概述

### 1.1 测试目标

- 验证功能需求是否完整实现
- 确保系统稳定性和性能满足要求
- 验证多平台兼容性
- 确保数据安全和凭据加密

### 1.2 测试范围

| 测试域 | 范围 |
|--------|------|
| 功能测试 | 连接管理、数据采集、分析算法、报告生成 |
| 性能测试 | 大规模数据处理、并发采集、响应时间 |
| 兼容性测试 | Windows/麒麟/统信/MacOS，x86/arm |
| 安全测试 | 凭据加密、权限控制、日志脱敏 |
| 稳定性测试 | 长时间运行、异常恢复、资源泄漏 |

### 1.3 测试策略

| 策略 | 描述 |
|------|------|
| 单元测试 | 覆盖核心业务逻辑，目标覆盖率 ≥ 80% |
| 集成测试 | 验证模块间协作，主要测试端到端流程 |
| 系统测试 | 验证完整功能场景，基于用户故事 |
| 性能测试 | 使用压测工具模拟负载，验证性能指标 |
| 兼容性测试 | 在目标平台上实际运行验证 |

## 2. 测试环境

### 2.1 环境清单

| 平台 | 版本 | 架构 | 用途 |
|------|------|------|------|
| Windows | 10/11 | x86_64 | 开发、测试 |
| 麒麟 V10 | SP3 | x86_64/LoongArch | 兼容性测试 |
| 统信 UOS | 20 | x86_64/LoongArch | 兼容性测试 |
| macOS | 12+ | x86_64/arm64 | 兼容性测试 |

### 2.2 测试数据

| 数据类型 | 来源 | 规模 |
|----------|------|------|
| vCenter 环境 | 真实/模拟 | 3 集群, 10 主机, 100+ VM |
| 指标数据 | 生成 | 30 天历史, 5 分钟粒度 |
| 边界数据 | 构造 | 空值、异常值、超大数据 |

## 3. 测试类型

### 3.1 单元测试

#### 3.1.1 后端单元测试

```go
// 示例：僵尸 VM 检测器测试
func TestZombieAnalyzer_IsZombie(t *testing.T) {
    analyzer := NewZombieAnalyzer(db)

    tests := []struct {
        name     string
        vm       *VM
        metrics  *MetricStats
        expected bool
    }{
        {
            name: "低负载 VM",
            vm: &VM{ID: "vm-1", Name: "test-1", PowerState: "poweredOn"},
            metrics: &MetricStats{
                CPU:    MetricStat{Mean: 2.0, P95: 4.0},
                Memory: MetricStat{Mean: 5.0, P95: 8.0},
                DiskIO: DiskIOStats{IOPSMean: 5.0},
            },
            expected: true,
        },
        {
            name: "正常负载 VM",
            vm: &VM{ID: "vm-2", Name: "test-2", PowerState: "poweredOn"},
            metrics: &MetricStats{
                CPU:    MetricStat{Mean: 45.0, P95: 65.0},
                Memory: MetricStat{Mean: 55.0, P95: 75.0},
                DiskIO: DiskIOStats{IOPSMean: 150.0},
            },
            expected: false,
        },
        {
            name: "关机 VM",
            vm: &VM{ID: "vm-3", Name: "test-3", PowerState: "poweredOff"},
            metrics: &MetricStats{},
            expected: false,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            result := analyzer.IsZombie(tt.vm, tt.metrics)
            if tt.expected && result == nil {
                t.Error("expected zombie but got nil")
            }
            if !tt.expected && result != nil {
                t.Error("expected non-zombie but got result")
            }
        })
    }
}

// ETL 转换器测试
func TestTransformer_TransformVM(t *testing.T) {
    transformer := NewTransformer()

    rawVM := &RawVMData{
        ID:     "vm-123",
        Name:   "test-vm",
        VCPU:   4,
        VMem:   8192,
        VDisk:  100,
    }

    vm, err := transformer.TransformVM(rawVM)

    assert.NoError(t, err)
    assert.Equal(t, "vm-123", vm.ID)
    assert.Equal(t, "test-vm", vm.Name)
    assert.Equal(t, 4, vm.VCPU)
    assert.Equal(t, 8192, vm.VMem)
}
```

#### 3.1.2 前端单元测试

```typescript
// 示例：工具函数测试
import { formatBytes, formatDate } from '@/utils/format'

describe('formatBytes', () => {
  it('should format bytes correctly', () => {
    expect(formatBytes(1024)).toBe('1 KB')
    expect(formatBytes(1048576)).toBe('1 MB')
    expect(formatBytes(1073741824)).toBe('1 GB')
    expect(formatBytes(0)).toBe('0 B')
  })
})

describe('formatDate', () => {
  it('should format timestamp correctly', () => {
    const timestamp = 1678900000
    const result = formatDate(timestamp)
    expect(result).toMatch(/\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}/)
  })
})
```

### 3.2 集成测试

#### 3.2.1 采集流程集成测试

```go
func TestCollectIntegration(t *testing.T) {
    // 1. 创建测试连接
    conn := &Connection{
        ID:       "test-conn-1",
        Type:     "vcenter",
        Endpoint: "https://test-vcenter.local",
        Username: "test-user",
        Password: "test-pass",
    }

    // 2. 创建采集任务
    task := &CollectTask{
        ID:           "task-1",
        ConnectionID: conn.ID,
        Scope:        CollectScope{ClusterIDs: []string{"cluster-1"}},
    }

    // 3. 执行采集
    result, err := taskExecutor.Execute(task)

    // 4. 验证结果
    assert.NoError(t, err)
    assert.NotNil(t, result)
    assert.Greater(t, len(result.Clusters), 0)
    assert.Greater(t, len(result.Hosts), 0)
    assert.Greater(t, len(result.VMs), 0)

    // 5. 验证数据入库
    clusters, _ := clusterRepo.List(context.Background(), nil)
    assert.Greater(t, len(clusters), 0)
}
```

### 3.3 系统测试

#### 3.3.1 功能测试用例

| ID | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|----|----------|----------|----------|----------|
| TC-001 | 创建 vCenter 连接 | 应用启动 | 1. 输入连接信息<br>2. 点击测试<br>3. 保存 | 连接创建成功，状态正常 |
| TC-002 | 采集任务执行 | 已有可用连接 | 1. 配置采集范围<br>2. 启动任务<br>3. 等待完成 | 任务完成，数据入库 |
| TC-003 | 僵尸 VM 检测 | 已有指标数据 | 1. 运行分析<br>2. 查看结果 | 识别低负载 VM，展示证据 |
| TC-004 | Right Size 分析 | 已有指标数据 | 1. 运行分析<br>2. 查看建议 | 提供配置建议和节省估算 |
| TC-005 | 报告生成导出 | 分析完成 | 1. 生成报告<br>2. 导出 PDF | 报告内容完整，格式正确 |

### 3.4 性能测试

#### 3.4.1 性能指标

| 场景 | 指标 | 目标值 |
|------|------|--------|
| 应用启动 | 冷启动时间 | < 3 秒 |
| 页面切换 | 响应时间 | < 500ms |
| 列表加载 | 1000 条数据 | < 1 秒 |
| 数据采集 | 100 VM 规模 | < 5 分钟 |
| 分析执行 | 单 VM 分析 | < 2 秒 |
| 报告生成 | 完整报告 | < 30 秒 |

#### 3.4.2 性能测试场景

```go
// 并发采集测试
func BenchmarkConcurrentCollect(b *testing.B) {
    executor := NewTaskExecutor(5) // 5 并发

    for i := 0; i < b.N; i++ {
        tasks := createTestTasks(10)
        executor.ExecuteAll(tasks)
    }
}

// 大规模数据查询测试
func BenchmarkLargeQuery(b *testing.B) {
    repo := NewVMRepository(db)

    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        repo.List(context.Background(), &VMFilter{
            Limit: 1000,
        })
    }
}
```

### 3.5 兼容性测试

#### 3.5.1 兼容性测试矩阵

| 平台 | 版本 | 架构 | 测试项 | 状态 |
|------|------|------|--------|------|
| Windows | 10 | x86_64 | 安装/运行/UI | 待测试 |
| Windows | 11 | x86_64 | 安装/运行/UI | 待测试 |
| 麒麟 V10 | SP3 | x86_64 | 安装/运行/UI | 待测试 |
| 麒麟 V10 | SP3 | LoongArch | 安装/运行/UI | 待测试 |
| 统信 UOS | 20 | x86_64 | 安装/运行/UI | 待测试 |
| 统信 UOS | 20 | LoongArch | 安装/运行/UI | 待测试 |
| macOS | 12+ | x86_64 | 安装/运行/UI | 待测试 |
| macOS | 12+ | arm64 | 安装/运行/UI | 待测试 |

### 3.6 安全测试

#### 3.6.1 安全测试项

| 测试项 | 测试方法 | 预期结果 |
|--------|----------|----------|
| 凭据加密存储 | 检查数据库文件 | 密码字段为加密数据 |
| 日志脱敏 | 搜索日志文件 | 不包含明文密码 |
| 权限控制 | 尝试未授权操作 | 操作被拒绝 |
| SQL 注入 | 输入恶意参数 | 参数被正确转义 |
| 路径遍历 | 输入 "../" 路径 | 路径被验证拒绝 |

## 4. 测试执行

### 4.1 测试阶段

| 阶段 | 时间 | 内容 |
|------|------|------|
| 单元测试 | 开发过程中 | 开发人员自测 |
| 集成测试 | 每次构建 | CI 自动执行 |
| 系统测试 | 提测后 | 测试团队执行 |
| 性能测试 | 发版前 | 性能专项测试 |
| 兼容性测试 | 发版前 | 多平台验证 |

### 4.2 测试准入标准

- [ ] 单元测试通过率 ≥ 95%
- [ ] 代码覆盖率 ≥ 80%
- [ ] 无 P0/P1 级别缺陷
- [ ] 性能指标满足要求

### 4.3 测试准出标准

- [ ] 所有测试用例执行完成
- [ ] 缺陷修复率 ≥ 95%
- [ ] 遗留缺陷评估风险可接受
- [ ] 性能测试报告完整

## 5. 缺陷管理

### 5.1 缺陷分级

| 级别 | 描述 | 示例 |
|------|------|------|
| P0 | 阻塞性缺陷，无法继续测试 | 应用无法启动 |
| P1 | 严重功能缺陷，主流程受阻 | 无法保存连接配置 |
| P2 | 一般功能缺陷，有 workaround | 某筛选条件不生效 |
| P3 | 轻微问题，不影响功能 | UI 显示问题 |
| P4 | 优化建议 | 交互体验改进 |

### 5.2 缺陷报告模板

```markdown
## 缺陷标题
[模块] 简要描述问题

## 缺陷信息
- **缺陷 ID**: BUG-001
- **级别**: P1
- **状态**: Open
- **发现人**: xxx
- **发现时间**: 2026-02-07

## 环境信息
- 操作系统: Windows 11
- 应用版本: v0.0.1

## 复现步骤
1. 步骤一
2. 步骤二
3. 步骤三

## 预期结果
描述预期行为

## 实际结果
描述实际行为

## 附件
- 截图/日志
```

## 6. 测试交付物

### 6.1 交付物清单

| 交付物 | 说明 |
|--------|------|
| 测试用例 | 所有测试用例文档 |
| 测试报告 | 包含测试结果、覆盖率、缺陷统计 |
| 性能报告 | 性能测试数据和分析 |
| 兼容性报告 | 多平台测试结果 |
| 缺陷清单 | 所有发现的缺陷列表 |

### 6.2 测试报告模板

```markdown
# JustFit 测试报告

## 1. 概述
- 测试版本: v0.0.1
- 测试时间: 2026-02-01 ~ 2026-02-07
- 测试人员: xxx

## 2. 测试执行情况
| 测试类型 | 计划用例 | 执行用例 | 通过率 |
|----------|----------|----------|--------|
| 单元测试 | 150 | 150 | 98% |
| 集成测试 | 50 | 50 | 96% |
| 系统测试 | 80 | 80 | 92% |

## 3. 缺陷统计
| 级别 | 数量 | 已修复 | 遗留 |
|------|------|--------|------|
| P0 | 2 | 2 | 0 |
| P1 | 5 | 4 | 1 |
| P2 | 12 | 10 | 2 |

## 4. 结论
- [ ] 通过
- [ ] 条件通过
- [ ] 不通过

## 5. 风险评估
...
```

## 7. 自动化测试

### 7.1 自动化测试策略

| 类型 | 工具 | 覆盖范围 |
|------|------|----------|
| 单元测试 | Go test, Vitest | 后端逻辑, 前端工具函数 |
| 集成测试 | Go test + Testify | API 接口测试 |
| E2E 测试 | Playwright | 核心用户流程 |
| 性能测试 | Go benchmark | 后端性能瓶颈 |

### 7.2 CI/CD 集成

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run backend tests
        run: |
          cd backend
          go test -v -race -coverprofile=coverage.out ./...

      - name: Run frontend tests
        run: |
          cd frontend
          npm ci
          npm run test

      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

## 8. 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-07 | 初始版本 | - |
