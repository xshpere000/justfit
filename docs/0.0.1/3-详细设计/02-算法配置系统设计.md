# JustFit 算法配置系统设计文档

## 0. 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 算法配置系统设计文档 |
| 版本 | v1.0 |
| 日期 | 2026-02-08 |
| 项目版本 | v0.0.1 Beta |
| 状态 | 已确认 |

## 1. 算法配置系统概述

### 1.1 设计目标

支持**4种分析模式** + **灵活参数配置** + **多时间窗口**，满足不同用户场景：

| 用户类型 | 使用场景 | 推荐模式 |
|---------|---------|---------|
| 保守型管理员 | 首次试用、生产环境谨慎操作 | **安全模式** |
| 成本优化团队 | 平衡风险与成本节省 | **节省模式** |
| 激进优化团队 | 最大化资源利用率 | **激进模式** |
| 高级用户 | 根据业务特点精调参数 | **自定义模式** |

### 1.2 核心特性

```
┌───────────────────────────────────────────────────────────┐
│              算法配置系统架构                              │
├───────────────────────────────────────────────────────────┤
│                                                           │
│  ┌─────────────────────────────────────────────────┐     │
│  │           前端配置界面                           │     │
│  ├─────────────────────────────────────────────────┤     │
│  │  • 模式选择器（安全/节省/激进/自定义）           │     │
│  │  • 时间窗口选择器（7天/30天/90天/1年/自定义）    │     │
│  │  • 参数调节面板（自定义模式可见）               │     │
│  │  • 预览影响范围（预估检测数量）                 │     │
│  └─────────────────────────────────────────────────┘     │
│                          ▼                                │
│  ┌─────────────────────────────────────────────────┐     │
│  │         配置管理层 (Config Manager)              │     │
│  ├─────────────────────────────────────────────────┤     │
│  │  • 模式 → 参数映射                              │     │
│  │  • 参数验证与合法性检查                         │     │
│  │  • 配置缓存与版本管理                           │     │
│  │  • 配置持久化（SQLite）                         │     │
│  └─────────────────────────────────────────────────┘     │
│                          ▼                                │
│  ┌─────────────────────────────────────────────────┐     │
│  │          分析引擎 (Analyzer Engine)              │     │
│  ├─────────────────────────────────────────────────┤     │
│  │  • 僵尸VM检测引擎                               │     │
│  │  • Right Size评估引擎                           │     │
│  │  • 潮汐模式检测引擎                             │     │
│  │  • 健康评分引擎                                 │     │
│  └─────────────────────────────────────────────────┘     │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

## 2. 分析模式设计

### 2.1 模式参数矩阵

#### 2.1.1 僵尸VM检测模式参数

| 参数 | 安全模式 | 节省模式 | 激进模式 | 单位 | 说明 |
|------|---------|---------|---------|------|------|
| **分析窗口** | 30天 | 14天 | 7天 | 天 | 观察周期，越长越保守 |
| **CPU阈值** | 3% | 5% | 10% | % | 平均CPU使用率上限 |
| **内存阈值** | 5% | 10% | 15% | % | 平均内存使用率上限 |
| **磁盘IO阈值** | 5 | 10 | 20 | IOPS | 平均磁盘IO操作数 |
| **网络阈值** | 50 | 100 | 200 | KB/s | 平均网络流量 |
| **低负载天数比例** | ≥90% | ≥80% | ≥70% | % | 低负载天数占比 |
| **最小置信度** | 95 | 85 | 75 | 分 | 检测置信度下限 |
| **排除近期启动** | 30天 | 14天 | 7天 | 天 | 排除新启动的VM |

**模式特点**：
- **安全模式**：非常严格的条件，几乎确定是僵尸才会报告，误报率极低
- **节省模式**：平衡的参数，适合大多数场景，兼顾准确性和检出率
- **激进模式**：宽松的条件，检出更多潜在优化对象，需人工复核

#### 2.1.2 Right Size评估模式参数

| 参数 | 安全模式 | 节省模式 | 激进模式 | 单位 | 说明 |
|------|---------|---------|---------|------|------|
| **分析窗口** | 30天 | 14天 | 7天 | 天 | 数据采集周期 |
| **百分位参数** | P95 | P90 | P85 | - | 使用率计算基准 |
| **缓冲比例** | 1.30 | 1.20 | 1.10 | 倍数 | 安全余量系数 |
| **扩容阈值** | >90% | >85% | >80% | % | 触发扩容建议的P95使用率 |
| **缩容阈值** | <40% | <50% | <60% | % | 触发缩容建议的P95使用率 |
| **最小CPU** | 2核 | 1核 | 1核 | vCPU | 最小推荐配置 |
| **最小内存** | 2GB | 1GB | 512MB | MB | 最小推荐配置 |
| **调整粒度** | 严格整数 | 整数优先 | 精确计算| - | 推荐配置的调整方式 |
| **风险阈值** | 波动>30% | 波动>40% | 波动>50% | % | 标记为高风险的波动率 |

**特殊规则**：
- **安全模式**：宁可多留资源，避免性能问题，推荐值偏保守
- **节省模式**：基于P90+20%余量，平衡成本与风险
- **激进模式**：基于P85+10%余量，最大化资源利用率

#### 2.1.3 潮汐模式检测参数

| 参数 | 安全模式 | 节省模式 | 激进模式 | 单位 | 说明 |
|------|---------|---------|---------|------|------|
| **分析窗口** | 60天 | 30天 | 14天 | 天 | 周期检测需要足够数据 |
| **最小稳定性评分** | 80 | 70 | 60 | 分 | 周期模式的稳定性要求 |
| **最小变化幅度** | 50% | 40% | 30% | % | 峰谷差异最小值 |
| **日周期置信度** | ≥85% | ≥75% | ≥65% | % | 日模式的可信度 |
| **周周期置信度** | ≥85% | ≥75% | ≥65% | % | 周模式的可信度 |
| **最小峰谷时长** | 4小时 | 3小时 | 2小时 | 小时 | 有效时段的最短持续时间 |
| **连续性要求** | ≥90% | ≥80% | ≥70% | % | 模式在窗口中的持续性 |

**特殊规则**：
- **安全模式**：需要非常明显和稳定的周期才建议启停
- **节省模式**：较明显的周期即可，适合大多数周期性业务
- **激进模式**：检测更多潜在周期，可能需要人工验证

#### 2.1.4 健康评分参数

| 参数 | 安全模式 | 节省模式 | 激进模式 | 单位 | 说明 |
|------|---------|---------|---------|------|------|
| **资源均衡权重** | 0.5 | 0.4 | 0.3 | - | 均衡度在总分中的占比 |
| **超配风险权重** | 0.3 | 0.3 | 0.3 | - | 超配风险在总分中的占比 |
| **热点集中权重** | 0.2 | 0.3 | 0.4 | - | 热点集中度在总分中的占比 |
| **超配告警阈值** | >1.2倍 | >1.5倍 | >2.0倍 | 倍数 | CPU/内存超配比例告警线 |
| **均衡CV阈值** | >0.3 | >0.5 | >0.7 | - | 变异系数（标准差/均值） |
| **热点定义** | >80%负载 | >90%负载 | >95%负载 | % | 判定热点主机的负载阈值 |

**权重说明**：
- **安全模式**：重视资源均衡和超配风险，避免系统不稳定
- **节省模式**：平衡三个维度，综合评估健康状况
- **激进模式**：关注热点集中度，识别性能瓶颈

### 2.2 模式配置数据结构

```go
// AnalysisMode 分析模式
type AnalysisMode string

const (
    ModeSafe       AnalysisMode = "safe"       // 安全模式
    ModeCostSaving AnalysisMode = "cost_saving" // 节省模式
    ModeAggressive AnalysisMode = "aggressive" // 激进模式
    ModeCustom     AnalysisMode = "custom"     // 自定义模式
)

// AnalysisConfig 分析配置（顶层）
type AnalysisConfig struct {
    ID          uint          `json:"id"`
    Name        string        `json:"name"`         // 配置名称
    Mode        AnalysisMode  `json:"mode"`         // 分析模式
    Description string        `json:"description"`  // 配置说明
    
    // 通用参数
    TimeWindow  int           `json:"time_window"`  // 分析窗口（天）
    
    // 各算法配置
    ZombieVM    *ZombieVMConfig    `json:"zombie_vm"`
    RightSize   *RightSizeConfig   `json:"right_size"`
    Tidal       *TidalConfig       `json:"tidal"`
    Health      *HealthConfig      `json:"health"`
    
    // 元数据
    CreatedAt   time.Time     `json:"created_at"`
    UpdatedAt   time.Time     `json:"updated_at"`
    IsDefault   bool          `json:"is_default"`   // 是否为默认配置
    IsSystem    bool          `json:"is_system"`    // 是否为系统预设
}

// ZombieVMConfig 僵尸VM检测配置
type ZombieVMConfig struct {
    AnalysisDays         int     `json:"analysis_days"`          // 分析天数
    CPUThreshold         float64 `json:"cpu_threshold"`          // CPU阈值 (%)
    MemoryThreshold      float64 `json:"memory_threshold"`       // 内存阈值 (%)
    DiskIOThreshold      float64 `json:"disk_io_threshold"`      // 磁盘IO阈值 (IOPS)
    NetworkThreshold     float64 `json:"network_threshold"`      // 网络阈值 (KB/s)
    LowUsageDayRatio     float64 `json:"low_usage_day_ratio"`    // 低负载天数比例
    MinConfidence        float64 `json:"min_confidence"`         // 最小置信度
    ExcludeRecentStarted int     `json:"exclude_recent_started"` // 排除近期启动(天)
}

// RightSizeConfig Right Size评估配置
type RightSizeConfig struct {
    AnalysisDays     int     `json:"analysis_days"`      // 分析天数
    Percentile       int     `json:"percentile"`         // 百分位 (85, 90, 95)
    BufferRatio      float64 `json:"buffer_ratio"`       // 缓冲比例 (1.1, 1.2, 1.3)
    ScaleUpThreshold float64 `json:"scale_up_threshold"` // 扩容阈值 (%)
    ScaleDownThreshold float64 `json:"scale_down_threshold"` // 缩容阈值 (%)
    MinCPU           int     `json:"min_cpu"`            // 最小CPU (核心)
    MinMemoryMB      int     `json:"min_memory_mb"`      // 最小内存 (MB)
    AdjustmentGranularity string `json:"adjustment_granularity"` // 调整粒度
    RiskThreshold    float64 `json:"risk_threshold"`     // 风险阈值 (%)
}

// TidalConfig 潮汐检测配置
type TidalConfig struct {
    AnalysisDays          int     `json:"analysis_days"`            // 分析天数
    MinStabilityScore     float64 `json:"min_stability_score"`      // 最小稳定性评分
    MinVariation          float64 `json:"min_variation"`            // 最小变化幅度 (%)
    DailyPatternConfidence float64 `json:"daily_pattern_confidence"` // 日周期置信度
    WeeklyPatternConfidence float64 `json:"weekly_pattern_confidence"` // 周周期置信度
    MinPeakTroughDuration int     `json:"min_peak_trough_duration"` // 最小峰谷时长(小时)
    ContinuityRequirement float64 `json:"continuity_requirement"`   // 连续性要求 (%)
}

// HealthConfig 健康评分配置
type HealthConfig struct {
    ResourceBalanceWeight  float64 `json:"resource_balance_weight"`  // 资源均衡权重
    OvercommitRiskWeight   float64 `json:"overcommit_risk_weight"`   // 超配风险权重
    HotspotWeight          float64 `json:"hotspot_weight"`           // 热点集中权重
    OvercommitAlertRatio   float64 `json:"overcommit_alert_ratio"`   // 超配告警阈值
    BalanceCVThreshold     float64 `json:"balance_cv_threshold"`     // 均衡CV阈值
    HotspotLoadThreshold   float64 `json:"hotspot_load_threshold"`   // 热点负载阈值 (%)
}
```

## 3. 配置管理器实现

### 3.1 配置工厂

```go
package analyzer

// ConfigFactory 配置工厂
type ConfigFactory struct{}

// NewConfigFactory 创建配置工厂
func NewConfigFactory() *ConfigFactory {
    return &ConfigFactory{}
}

// CreateConfig 根据模式创建配置
func (f *ConfigFactory) CreateConfig(mode AnalysisMode, timeWindow int) *AnalysisConfig {
    config := &AnalysisConfig{
        Mode:       mode,
        TimeWindow: timeWindow,
    }
    
    switch mode {
    case ModeSafe:
        config.ZombieVM = f.createSafeZombieConfig(timeWindow)
        config.RightSize = f.createSafeRightSizeConfig(timeWindow)
        config.Tidal = f.createSafeTidalConfig(timeWindow)
        config.Health = f.createSafeHealthConfig()
        
    case ModeCostSaving:
        config.ZombieVM = f.createCostSavingZombieConfig(timeWindow)
        config.RightSize = f.createCostSavingRightSizeConfig(timeWindow)
        config.Tidal = f.createCostSavingTidalConfig(timeWindow)
        config.Health = f.createCostSavingHealthConfig()
        
    case ModeAggressive:
        config.ZombieVM = f.createAggressiveZombieConfig(timeWindow)
        config.RightSize = f.createAggressiveRightSizeConfig(timeWindow)
        config.Tidal = f.createAggressiveTidalConfig(timeWindow)
        config.Health = f.createAggressiveHealthConfig()
        
    case ModeCustom:
        // 自定义模式使用默认值，由用户修改
        config.ZombieVM = f.createCostSavingZombieConfig(timeWindow)
        config.RightSize = f.createCostSavingRightSizeConfig(timeWindow)
        config.Tidal = f.createCostSavingTidalConfig(timeWindow)
        config.Health = f.createCostSavingHealthConfig()
    }
    
    return config
}

// createSafeZombieConfig 创建安全模式的僵尸VM配置
func (f *ConfigFactory) createSafeZombieConfig(timeWindow int) *ZombieVMConfig {
    // 使用传入的 timeWindow，如果为0则使用默认值30天
    days := timeWindow
    if days == 0 {
        days = 30
    }
    
    return &ZombieVMConfig{
        AnalysisDays:         days,
        CPUThreshold:         3.0,   // 非常低的CPU使用率
        MemoryThreshold:      5.0,   // 非常低的内存使用率
        DiskIOThreshold:      5.0,   // 几乎无磁盘活动
        NetworkThreshold:     50.0,  // 极低网络流量
        LowUsageDayRatio:     0.90,  // 90%的天数都是低负载
        MinConfidence:        95.0,  // 非常高的置信度
        ExcludeRecentStarted: 30,    // 排除30天内启动的
    }
}

func (f *ConfigFactory) createCostSavingZombieConfig(timeWindow int) *ZombieVMConfig {
    days := timeWindow
    if days == 0 {
        days = 14
    }
    
    return &ZombieVMConfig{
        AnalysisDays:         days,
        CPUThreshold:         5.0,   // 标准僵尸阈值
        MemoryThreshold:      10.0,
        DiskIOThreshold:      10.0,
        NetworkThreshold:     100.0,
        LowUsageDayRatio:     0.80,  // 80%低负载
        MinConfidence:        85.0,  // 较高置信度
        ExcludeRecentStarted: 14,
    }
}

func (f *ConfigFactory) createAggressiveZombieConfig(timeWindow int) *ZombieVMConfig {
    days := timeWindow
    if days == 0 {
        days = 7
    }
    
    return &ZombieVMConfig{
        AnalysisDays:         days,
        CPUThreshold:         10.0,  // 更宽松的阈值
        MemoryThreshold:      15.0,
        DiskIOThreshold:      20.0,
        NetworkThreshold:     200.0,
        LowUsageDayRatio:     0.70,  // 70%低负载即可
        MinConfidence:        75.0,  // 较低置信度
        ExcludeRecentStarted: 7,
    }
}

// createSafeRightSizeConfig 创建安全模式的Right Size配置
func (f *ConfigFactory) createSafeRightSizeConfig(timeWindow int) *RightSizeConfig {
    days := timeWindow
    if days == 0 {
        days = 30
    }
    
    return &RightSizeConfig{
        AnalysisDays:           days,
        Percentile:             95,   // P95
        BufferRatio:            1.30, // 30%安全余量
        ScaleUpThreshold:       90.0, // >90%才扩容
        ScaleDownThreshold:     40.0, // <40%才缩容
        MinCPU:                 2,    // 最少2核
        MinMemoryMB:            2048, // 最少2GB
        AdjustmentGranularity:  "strict_integer", // 严格整数
        RiskThreshold:          30.0, // 波动>30%标记高风险
    }
}

func (f *ConfigFactory) createCostSavingRightSizeConfig(timeWindow int) *RightSizeConfig {
    days := timeWindow
    if days == 0 {
        days = 14
    }
    
    return &RightSizeConfig{
        AnalysisDays:           days,
        Percentile:             90,   // P90
        BufferRatio:            1.20, // 20%余量
        ScaleUpThreshold:       85.0,
        ScaleDownThreshold:     50.0,
        MinCPU:                 1,
        MinMemoryMB:            1024, // 1GB
        AdjustmentGranularity:  "integer_preferred",
        RiskThreshold:          40.0,
    }
}

func (f *ConfigFactory) createAggressiveRightSizeConfig(timeWindow int) *RightSizeConfig {
    days := timeWindow
    if days == 0 {
        days = 7
    }
    
    return &RightSizeConfig{
        AnalysisDays:           days,
        Percentile:             85,   // P85
        BufferRatio:            1.10, // 仅10%余量
        ScaleUpThreshold:       80.0,
        ScaleDownThreshold:     60.0,
        MinCPU:                 1,
        MinMemoryMB:            512,  // 512MB
        AdjustmentGranularity:  "precise",
        RiskThreshold:          50.0,
    }
}

// createSafeTidalConfig 创建安全模式的潮汐检测配置
func (f *ConfigFactory) createSafeTidalConfig(timeWindow int) *TidalConfig {
    days := timeWindow
    if days == 0 {
        days = 60 // 潮汐检测默认需要更长周期
    }
    
    return &TidalConfig{
        AnalysisDays:            days,
        MinStabilityScore:       80.0,  // 高稳定性要求
        MinVariation:            50.0,  // 50%变化幅度
        DailyPatternConfidence:  85.0,
        WeeklyPatternConfidence: 85.0,
        MinPeakTroughDuration:   4,     // 峰谷至少4小时
        ContinuityRequirement:   0.90,  // 90%连续性
    }
}

func (f *ConfigFactory) createCostSavingTidalConfig(timeWindow int) *TidalConfig {
    days := timeWindow
    if days == 0 {
        days = 30
    }
    
    return &TidalConfig{
        AnalysisDays:            days,
        MinStabilityScore:       70.0,
        MinVariation:            40.0,
        DailyPatternConfidence:  75.0,
        WeeklyPatternConfidence: 75.0,
        MinPeakTroughDuration:   3,
        ContinuityRequirement:   0.80,
    }
}

func (f *ConfigFactory) createAggressiveTidalConfig(timeWindow int) *TidalConfig {
    days := timeWindow
    if days == 0 {
        days = 14
    }
    
    return &TidalConfig{
        AnalysisDays:            days,
        MinStabilityScore:       60.0,
        MinVariation:            30.0,
        DailyPatternConfidence:  65.0,
        WeeklyPatternConfidence: 65.0,
        MinPeakTroughDuration:   2,
        ContinuityRequirement:   0.70,
    }
}

// createSafeHealthConfig 创建安全模式的健康评分配置
func (f *ConfigFactory) createSafeHealthConfig() *HealthConfig {
    return &HealthConfig{
        ResourceBalanceWeight: 0.5,  // 重视均衡
        OvercommitRiskWeight:  0.3,  // 重视超配风险
        HotspotWeight:         0.2,
        OvercommitAlertRatio:  1.2,  // 超配1.2倍即告警
        BalanceCVThreshold:    0.3,  // 低CV阈值
        HotspotLoadThreshold:  80.0, // 80%负载即为热点
    }
}

func (f *ConfigFactory) createCostSavingHealthConfig() *HealthConfig {
    return &HealthConfig{
        ResourceBalanceWeight: 0.4,
        OvercommitRiskWeight:  0.3,
        HotspotWeight:         0.3,
        OvercommitAlertRatio:  1.5,
        BalanceCVThreshold:    0.5,
        HotspotLoadThreshold:  90.0,
    }
}

func (f *ConfigFactory) createAggressiveHealthConfig() *HealthConfig {
    return &HealthConfig{
        ResourceBalanceWeight: 0.3,
        OvercommitRiskWeight:  0.3,
        HotspotWeight:         0.4,  // 关注热点
        OvercommitAlertRatio:  2.0,  // 允许更高超配
        BalanceCVThreshold:    0.7,
        HotspotLoadThreshold:  95.0,
    }
}
```

### 3.2 配置验证器

```go
// ConfigValidator 配置验证器
type ConfigValidator struct{}

// Validate 验证配置合法性
func (v *ConfigValidator) Validate(config *AnalysisConfig) error {
    var errors []string
    
    // 验证时间窗口
    if config.TimeWindow < 1 || config.TimeWindow > 365 {
        errors = append(errors, "时间窗口必须在 1-365 天之间")
    }
    
    // 验证僵尸VM配置
    if err := v.validateZombieVM(config.ZombieVM); err != nil {
        errors = append(errors, err.Error())
    }
    
    // 验证Right Size配置
    if err := v.validateRightSize(config.RightSize); err != nil {
        errors = append(errors, err.Error())
    }
    
    // 验证潮汐配置
    if err := v.validateTidal(config.Tidal); err != nil {
        errors = append(errors, err.Error())
    }
    
    // 验证健康配置
    if err := v.validateHealth(config.Health); err != nil {
        errors = append(errors, err.Error())
    }
    
    if len(errors) > 0 {
        return fmt.Errorf("配置验证失败: %s", strings.Join(errors, "; "))
    }
    
    return nil
}

func (v *ConfigValidator) validateZombieVM(config *ZombieVMConfig) error {
    if config.CPUThreshold < 0 || config.CPUThreshold > 100 {
        return fmt.Errorf("CPU阈值必须在 0-100 之间")
    }
    if config.MemoryThreshold < 0 || config.MemoryThreshold > 100 {
        return fmt.Errorf("内存阈值必须在 0-100 之间")
    }
    if config.LowUsageDayRatio < 0 || config.LowUsageDayRatio > 1 {
        return fmt.Errorf("低负载天数比例必须在 0-1 之间")
    }
    if config.MinConfidence < 0 || config.MinConfidence > 100 {
        return fmt.Errorf("最小置信度必须在 0-100 之间")
    }
    return nil
}

func (v *ConfigValidator) validateRightSize(config *RightSizeConfig) error {
    if config.Percentile < 50 || config.Percentile > 99 {
        return fmt.Errorf("百分位必须在 50-99 之间")
    }
    if config.BufferRatio < 1.0 || config.BufferRatio > 2.0 {
        return fmt.Errorf("缓冲比例必须在 1.0-2.0 之间")
    }
    if config.MinCPU < 1 {
        return fmt.Errorf("最小CPU必须 ≥ 1")
    }
    if config.MinMemoryMB < 256 {
        return fmt.Errorf("最小内存必须 ≥ 256MB")
    }
    return nil
}

func (v *ConfigValidator) validateTidal(config *TidalConfig) error {
    if config.MinStabilityScore < 0 || config.MinStabilityScore > 100 {
        return fmt.Errorf("稳定性评分必须在 0-100 之间")
    }
    if config.MinVariation < 0 || config.MinVariation > 100 {
        return fmt.Errorf("变化幅度必须在 0-100 之间")
    }
    return nil
}

func (v *ConfigValidator) validateHealth(config *HealthConfig) error {
    totalWeight := config.ResourceBalanceWeight + config.OvercommitRiskWeight + config.HotspotWeight
    if math.Abs(totalWeight-1.0) > 0.01 {
        return fmt.Errorf("权重总和必须为 1.0，当前为 %.2f", totalWeight)
    }
    return nil
}
```

## 4. 前端配置界面设计

### 4.1 配置界面布局

```vue
<!-- AnalysisConfigPanel.vue -->
<template>
  <el-card class="config-panel">
    <template #header>
      <div class="config-header">
        <span>分析配置</span>
        <el-tag :type="modeTagType">{{ modeLabel }}</el-tag>
      </div>
    </template>
    
    <!-- 模式选择 -->
    <el-form :model="config" label-width="120px">
      <el-form-item label="分析模式">
        <el-radio-group v-model="config.mode" @change="onModeChange">
          <el-radio label="safe">
            <div class="mode-option">
              <div class="mode-title">
                <el-icon><Lock /></el-icon>
                安全模式
              </div>
              <div class="mode-desc">参数最保守，首次使用推荐</div>
            </div>
          </el-radio>
          
          <el-radio label="cost_saving">
            <div class="mode-option">
              <div class="mode-title">
                <el-icon><CoinOutlined /></el-icon>
                节省模式
              </div>
              <div class="mode-desc">平衡风险与成本，适合大多数场景</div>
            </div>
          </el-radio>
          
          <el-radio label="aggressive">
            <div class="mode-option">
              <div class="mode-title">
                <el-icon><Flash /></el-icon>
                激进模式
              </div>
              <div class="mode-desc">最大化资源利用率，需人工复核</div>
            </div>
          </el-radio>
          
          <el-radio label="custom">
            <div class="mode-option">
              <div class="mode-title">
                <el-icon><Setting /></el-icon>
                自定义模式
              </div>
              <div class="mode-desc">高级用户精细调整参数</div>
            </div>
          </el-radio>
        </el-radio-group>
      </el-form-item>
      
      <!-- 时间窗口选择 -->
      <el-form-item label="分析窗口">
        <el-select v-model="config.timeWindow">
          <el-option label="7天（快速评估）" :value="7" />
          <el-option label="14天（推荐）" :value="14" />
          <el-option label="30天（全面分析）" :value="30" />
          <el-option label="90天（长期趋势）" :value="90" />
          <el-option label="1年（年度规划）" :value="365" />
          <el-option label="自定义" :value="0" />
        </el-select>
        
        <el-input-number
          v-if="config.timeWindow === 0"
          v-model="customDays"
          :min="1"
          :max="365"
          style="margin-left: 10px"
        />
      </el-form-item>
      
      <!-- 自定义模式参数面板 -->
      <el-collapse v-if="config.mode === 'custom'" class="custom-params">
        <el-collapse-item title="僵尸VM检测参数" name="zombie">
          <el-form-item label="CPU阈值 (%)">
            <el-slider v-model="config.zombieVM.cpuThreshold" :min="1" :max="20" :step="0.5" show-input />
          </el-form-item>
          <el-form-item label="内存阈值 (%)">
            <el-slider v-model="config.zombieVM.memoryThreshold" :min="1" :max="30" :step="0.5" show-input />
          </el-form-item>
          <el-form-item label="最小置信度">
            <el-slider v-model="config.zombieVM.minConfidence" :min="70" :max="100" :step="5" show-input />
          </el-form-item>
        </el-collapse-item>
        
        <el-collapse-item title="Right Size参数" name="rightsize">
          <el-form-item label="百分位">
            <el-select v-model="config.rightSize.percentile">
              <el-option label="P85 (激进)" :value="85" />
              <el-option label="P90 (平衡)" :value="90" />
              <el-option label="P95 (保守)" :value="95" />
            </el-select>
          </el-form-item>
          <el-form-item label="缓冲比例">
            <el-slider v-model="config.rightSize.bufferRatio" :min="1.05" :max="1.5" :step="0.05" show-input />
          </el-form-item>
        </el-collapse-item>
        
        <!-- 更多参数... -->
      </el-collapse>
      
      <!-- 影响预览 -->
      <el-card class="impact-preview" shadow="never">
        <div class="preview-title">预估影响范围</div>
        <el-row :gutter="20">
          <el-col :span="8">
            <el-statistic title="预计检出僵尸VM" :value="estimatedZombieCount" />
          </el-col>
          <el-col :span="8">
            <el-statistic title="预计Right Size调整" :value="estimatedRightSizeCount" />
          </el-col>
          <el-col :span="8">
            <el-statistic title="预计潮汐VM" :value="estimatedTidalCount" />
          </el-col>
        </el-row>
      </el-card>
      
      <!-- 操作按钮 -->
      <el-form-item>
        <el-button type="primary" @click="saveConfig">保存配置</el-button>
        <el-button @click="resetConfig">重置为默认</el-button>
        <el-button @click="previewResults">预览分析结果</el-button>
      </el-form-item>
    </el-form>
  </el-card>
</template>
```

### 4.2 配置参数对比视图

```typescript
// 配置对比工具
interface ModeComparison {
  parameter: string
  safe: string | number
  costSaving: string | number
  aggressive: string | number
  unit: string
  description: string
}

const zombieVMComparison: ModeComparison[] = [
  {
    parameter: '分析窗口',
    safe: 30,
    costSaving: 14,
    aggressive: 7,
    unit: '天',
    description: '数据采集的时间跨度'
  },
  {
    parameter: 'CPU阈值',
    safe: 3,
    costSaving: 5,
    aggressive: 10,
    unit: '%',
    description: '平均CPU使用率上限'
  },
  {
    parameter: '最小置信度',
    safe: 95,
    costSaving: 85,
    aggressive: 75,
    unit: '分',
    description: '检测结果的可信度要求'
  }
]
```

## 5. 配置持久化

### 5.1 数据库表设计

```sql
-- 分析配置表
CREATE TABLE analysis_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    mode TEXT NOT NULL,  -- 'safe', 'cost_saving', 'aggressive', 'custom'
    description TEXT,
    time_window INTEGER NOT NULL,
    
    -- JSON 格式存储各算法配置
    zombie_vm_config TEXT,
    right_size_config TEXT,
    tidal_config TEXT,
    health_config TEXT,
    
    -- 元数据
    is_default BOOLEAN DEFAULT 0,
    is_system BOOLEAN DEFAULT 0,
    created_by TEXT,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL
);

-- 创建系统默认配置
INSERT INTO analysis_configs (name, mode, description, time_window, is_system, is_default, zombie_vm_config, created_at, updated_at)
VALUES 
  ('系统默认 - 安全模式', 'safe', '保守参数，适合生产环境首次使用', 30, 1, 0, '{"analysis_days":30,"cpu_threshold":3.0,...}', strftime('%s'), strftime('%s')),
  ('系统默认 - 节省模式', 'cost_saving', '平衡的参数设置，推荐大多数场景使用', 14, 1, 1, '{"analysis_days":14,"cpu_threshold":5.0,...}', strftime('%s'), strftime('%s')),
  ('系统默认 - 激进模式', 'aggressive', '激进的优化策略，需要人工复核', 7, 1, 0, '{"analysis_days":7,"cpu_threshold":10.0,...}', strftime('%s'), strftime('%s'));
```

## 6. 使用示例

### 6.1 快速开始（使用预设模式）

```go
// 使用节省模式分析
factory := NewConfigFactory()
config := factory.CreateConfig(ModeCostSaving, 14) // 节省模式，14天窗口

engine := NewEngine(repos)

// 僵尸VM检测
zombieResults, err := engine.DetectZombieVMs(connectionID, config.ZombieVM)

// Right Size评估
rightSizeResults, err := engine.AnalyzeRightSize(connectionID, config.RightSize)

// 潮汐检测
tidalResults, err := engine.DetectTidalPattern(connectionID, config.Tidal)

// 健康评分
healthResult, err := engine.AnalyzeHealthScore(connectionID, config.Health)
```

### 6.2 自定义配置

```go
// 创建自定义配置
config := factory.CreateConfig(ModeCustom, 30)

// 修改僵尸VM参数
config.ZombieVM.CPUThreshold = 8.0        // 调整CPU阈值为8%
config.ZombieVM.MemoryThreshold = 12.0    // 调整内存阈值为12%
config.ZombieVM.MinConfidence = 80.0      // 降低置信度要求

// 修改Right Size参数
config.RightSize.Percentile = 90          // 使用P90
config.RightSize.BufferRatio = 1.15       // 15%缓冲

// 验证配置   validator := &ConfigValidator{}
if err := validator.Validate(config); err != nil {
    log.Fatal("配置验证失败:", err)
}

// 保存自定义配置
configRepo.Save(config)

// 使用自定义配置进行分析
zombieResults, _ := engine.DetectZombieVMs(connectionID, config.ZombieVM)
```

## 7. 总结

### 7.1 配置系统优势

| 优势 | 说明 |
|------|------|
| **场景适配** | 4种模式覆盖不同用户场景和风险偏好 |
| **灵活可扩展** | 支持自定义参数，满足高级用户需求 |
| **参数透明** | 清晰展示每个参数的含义和影响 |
| **配置管理** | 支持保存、加载、对比配置 |
| **预览功能** | 执行前预估分析影响范围 |

### 7.2 最佳实践

1. **首次使用**：选择安全模式，观察结果，逐步调整
2. **生产环境**：使用节省模式，平衡风险与收益
3. **优化阶段**：使用激进模式找出更多优化空间，但需人工复核
4. **特殊场景**：使用自定义模式，针对特定业务调优

