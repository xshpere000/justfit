# JustFit 部署指南

## 0. 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 部署指南 |
| 版本 | v1.0 |
| 日期 | 2026-02-07 |
| 项目版本 | v0.0.1 Beta |

## 1. 部署概述

### 1.1 支持平台

| 平台 | 架构 | 打包格式 | 签名 |
|------|------|----------|------|
| Windows 10/11 | x86_64 | NSIS Installer | 代码签名证书 |
| 麒麟 V10 | x86_64, LoongArch | AppImage, deb | GPG 签名 |
| 统信 UOS 20 | x86_64, LoongArch | AppImage, deb | GPG 签名 |
| macOS 12+ | x86_64, arm64 | DMG, ZIP | Apple Developer |

### 1.2 系统要求

#### Windows

| 组件 | 要求 |
|------|------|
| 操作系统 | Windows 10 1903+ / Windows 11 |
| 处理器 | x86_64, 2 核心以上 |
| 内存 | 4 GB 以上 |
| 磁盘 | 500 MB 可用空间 |
| 其他 | WebView2 Runtime (通常已预装) |

#### Linux (麒麟/统信)

| 组件 | 要求 |
|------|------|
| 操作系统 | 麒麟 V10 SP3+, 统信 UOS 20+ |
| 处理器 | x86_64 / LoongArch 3 |
| 内存 | 4 GB 以上 |
| 磁盘 | 500 MB 可用空间 |
| 其他 | GTK+ 3.0, WebKitGTK |

#### macOS

| 组件 | 要求 |
|------|------|
| 操作系统 | macOS 12 (Monterey) 或更高 |
| 处理器 | Intel (x86_64) 或 Apple Silicon (arm64) |
| 内存 | 4 GB 以上 |
| 磁盘 | 500 MB 可用空间 |

## 2. 开发环境搭建

### 2.1 依赖安装

#### Go 环境

```bash
# 下载 Go 1.21+
# https://go.dev/dl/

# 配置环境变量
export GOPATH=$HOME/go
export PATH=$PATH:$GOPATH/bin
export GO111MODULE=on

# 验证安装
go version
```

#### Node.js 环境

```bash
# 使用 nvm 安装 Node.js 18+
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
nvm install 18
nvm use 18

# 验证安装
node --version
npm --version
```

#### Wails CLI

```bash
# 安装 Wails v2
go install github.com/wailsapp/wails/v2/cmd/wails@latest

# 验证安装
wails version
```

### 2.2 项目构建

```bash
# 克隆项目
git clone https://github.com/your-org/justfit.git
cd justfit

# 安装前端依赖
cd frontend
npm install
cd ..

# 开发模式运行
wails dev

# 生产构建
wails build
```

## 3. 打包流程

### 3.1 交叉编译配置

```go
// wails.json
{
  "name": "JustFit",
  "outputfilename": "justfit",
  "frontend:install": "npm install",
  "frontend:build": "npm run build",
  "backend:build": "go build -ldflags '-s -w'",
  "author": {
    "name": "Your Company",
    "email": "support@example.com"
  },
  "info": {
    "companyName": "Your Company",
    "productName": "JustFit",
    "productVersion": "0.0.1",
    "copyright": "Copyright ........",
    "comments": "Multi-cloud resource optimization tool"
  }
}
```

### 3.2 Windows 打包

```bash
# 构建 Windows 可执行文件
set GOOS=windows
set GOARCH=amd64
wails build -platform windows/amd64

# 使用 NSIS 打包
# 需要安装 NSIS (https://nsis.sourceforge.io/)

# 或使用 Makensis
makensis installer.nsi
```

NSIS 脚本示例:

```nsi
; installer.nsi
!define APPNAME "JustFit"
!define COMPANYNAME "Your Company"
!define DESCRIPTION "Multi-cloud resource optimization tool"
!define VERSIONMAJOR 0
!define VERSIONMINOR 0
!define VERSIONBUILD 1

RequestExecutionLevel admin

InstallDir "$PROGRAMFILES\${APPNAME}"

Page directory
Page instfiles

Section "Install"
    SetOutPath $INSTDIR
    File /r "build\bin\justfit.exe"
    File /r "build\bin\*.dll"

    WriteUninstaller "$INSTDIR\uninstall.exe"

    CreateShortCut "$DESKTOP\${APPNAME}.lnk" "$INSTDIR\justfit.exe"
    CreateDirectory "$SMPROGRAMS\${APPNAME}"
    CreateShortCut "$SMPROGRAMS\${APPNAME}\${APPNAME}.lnk" "$INSTDIR\justfit.exe"
SectionEnd

Section "Uninstall"
    Delete "$INSTDIR\justfit.exe"
    Delete "$INSTDIR\uninstall.exe"
    RMDir /r "$INSTDIR"
    Delete "$DESKTOP\${APPNAME}.lnk"
    RMDir /r "$SMPROGRAMS\${APPNAME}"
SectionEnd
```

### 3.3 Linux 打包

```bash
# 构建 Linux 可执行文件 (x86_64)
GOOS=linux GOARCH=amd64 wails build -platform linux/amd64

# 构建 Linux 可执行文件 (LoongArch)
GOOS=linux GOARCH=loong64 wails build -platform linux/loong64

# 创建 AppImage
# 需要安装 linuxdeploy 和 appimagetool
linuxdeploy-x86_64.AppImage --appdir AppDir --executable justfit --icon-filename justfit.png --icon-type svg --output appimage

# 创建 deb 包
dpkg-deb --build justfit-deb justfit_0.0.1_amd64.deb
```

### 3.4 macOS 打包

```bash
# 构建 macOS 可执行文件 (Intel)
GOOS=darwin GOARCH=amd64 wails build -platform darwin/amd64

# 构建 macOS 可执行文件 (Apple Silicon)
GOOS=darwin GOARCH=arm64 wails build -platform darwin/arm64

# 创建 Universal Binary
lipo -create -output justfit-universal justfit-amd64 justfit-arm64

# 打包 DMG
hdiutil create -volname "JustFit" -srcfolder justfit.app -ov -format UDZO justfit.dmg
```

## 4. 签名流程

### 4.1 Windows 代码签名

```bash
# 使用 SignTool (需要代码签名证书)
signtool sign /f certificate.pfx /p password /t http://timestamp.digicert.com justfit.exe

# 验证签名
signtool verify /pa justfit.exe
```

### 4.2 Linux GPG 签名

```bash
# 创建 GPG 密钥
gpg --gen-key

# 签名 deb 包
dpkg-sig --sign builder justfit_0.0.1_amd64.deb

# 导出公钥供用户验证
gpg --export --armor > public-key.asc
```

### 4.3 macOS 签名

```bash
# 使用 Apple Developer 证书签名
codesign --force --deep --sign "Developer ID Application: Your Name" justfit.app

# 公证 (需要 Apple Developer 账号)
xcrun notarytool submit justfit.dmg --apple-id "your@email.com" --password "app-specific-password" --team-id "TEAM_ID" --wait

# 装订公证票据
xcrun stapler staple justfit.dmg
```

## 5. 安装部署

### 5.1 Windows 安装

```powershell
# 方法 1: 使用安装包
# 双击 JustFit-0.0.1-setup.exe

# 方法 2: 手动安装
# 1. 解压 ZIP 包
# 2. 将文件复制到 C:\Program Files\JustFit\
# 3. 创建快捷方式
```

### 5.2 Linux 安装

```bash
# 方法 1: 使用 deb 包
sudo dpkg -i justfit_0.0.1_amd64.deb

# 方法 2: 使用 AppImage
chmod +x JustFit-0.0.1.AppImage
./JustFit-0.0.1.AppImage

# 方法 3: 手动安装
tar -xzf justfit-linux-amd64.tar.gz
sudo cp justfit /usr/local/bin/
sudo chmod +x /usr/local/bin/justfit
```

### 5.3 macOS 安装

```bash
# 方法 1: 使用 DMG
# 双击 JustFit.dmg
# 拖动到 Applications 文件夹

# 方法 2: 使用 ZIP
unzip justfit-macos.zip
cp -R JustFit.app /Applications/
```

## 6. 配置管理

### 6.1 配置文件位置

| 平台 | 配置路径 |
|------|----------|
| Windows | %APPDATA%\JustFit\ |
| Linux | ~/.config/JustFit/ |
| macOS | ~/Library/Application Support/JustFit/ |

### 6.2 配置文件结构

```json
{
  "app": {
    "name": "JustFit",
    "version": "0.0.1",
    "environment": "production"
  },
  "database": {
    "path": "justfit.db",
    "retention_days": 90
  },
  "collect": {
    "sample_interval": 300,
    "max_concurrent": 3,
    "timeout": 3600
  },
  "analysis": {
    "zombie": {
      "duration_days": 14,
      "cpu_threshold": 5.0,
      "mem_threshold": 10.0
    },
    "rightsize": {
      "percentile": 95,
      "buffer_ratio": 0.2
    }
  },
  "ui": {
    "refresh_interval": 5000,
    "theme": "auto"
  },
  "log": {
    "level": "info",
    "max_size": 100,
    "max_backups": 5
  }
}
```

## 7. 升级策略

### 7.1 版本检查

```go
// 检查更新
func CheckForUpdates() (*UpdateInfo, error) {
    currentVersion := "0.0.1"
    releaseURL := "https://github.com/your-org/justfit/releases/latest"

    // 获取最新版本信息
    resp, err := http.Get(releaseURL)
    if err != nil {
        return nil, err
    }
    defer resp.Body.Close()

    // 解析版本号
    latestVersion := parseVersionFromURL(resp.Request.URL.String())

    return &UpdateInfo{
        Current: currentVersion,
        Latest:  latestVersion,
        HasUpdate: currentVersion != latestVersion,
    }, nil
}
```

### 7.2 数据迁移

```go
// 数据库版本管理
type Migration struct {
    Version int
    Name    string
    Up      func(*sql.Tx) error
    Down    func(*sql.Tx) error
}

var migrations = []Migration{
    {
        Version: 1,
        Name:    "Initial schema",
        Up:      schemaV1,
    },
    {
        Version: 2,
        Name:    "Add alerts table",
        Up:      schemaV2,
    },
}

// 执行迁移
func Migrate(db *sql.DB) error {
    currentVersion := getCurrentVersion(db)

    for _, m := range migrations {
        if m.Version > currentVersion {
            tx, _ := db.Begin()
            if err := m.Up(tx); err != nil {
                tx.Rollback()
                return err
            }
            setVersion(db, m.Version)
            tx.Commit()
        }
    }

    return nil
}
```

## 8. 故障排查

### 8.1 常见问题

| 问题 | 原因 | 解决方法 |
|------|------|----------|
| 应用无法启动 | WebView2 缺失 | 安装 WebView2 Runtime |
| 连接失败 | 网络问题 | 检查防火墙和网络连通性 |
| 数据库错误 | 文件损坏 | 恢复备份或重建数据库 |
| 采集卡住 | 超时设置过短 | 调整超时配置 |

### 8.2 日志查看

```bash
# Windows
type %APPDATA%\JustFit\logs\justfit.log

# Linux
tail -f ~/.config/JustFit/logs/justfit.log

# macOS
tail -f ~/Library/Logs/JustFit/justfit.log
```

### 8.3 诊断包生成

```go
// 导出诊断包
func ExportDiagnosticPackage() (string, error) {
    zipPath := filepath.Join(os.TempDir(), fmt.Sprintf("justfit-diag-%s.zip", time.Now().Format("20060102-150405")))

    // 创建 ZIP 文件
    z := zip.NewWriter(zipPath)
    defer z.Close()

    // 添加日志文件
    addFileToZip(z, getLogPath(), "logs/")

    // 添加配置文件
    addFileToZip(z, getConfigPath(), "config/")

    // 添加数据库
    addFileToZip(z, getDatabasePath(), "data/")

    // 添加系统信息
    addSystemInfo(z, "system-info.txt")

    return zipPath, nil
}
```

## 9. 卸载

### 9.1 Windows 卸载

```powershell
# 方法 1: 控制面板
# 控制面板 > 程序和功能 > JustFit > 卸载

# 方法 2: 命令行
uninstall.exe /S

# 手动清理配置
Remove-Item -Recurse -Force $env:APPDATA\JustFit
```

### 9.2 Linux 卸载

```bash
# deb 包
sudo dpkg -r justfit

# 清理配置
rm -rf ~/.config/JustFit
```

### 9.3 macOS 卸载

```bash
# 删除应用
rm -rf /Applications/JustFit.app

# 清理配置
rm -rf ~/Library/Application Support/JustFit
rm -rf ~/Library/Logs/JustFit
rm -rf ~/Library/Caches/JustFit
```

## 10. 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-07 | 初始版本 | - |
