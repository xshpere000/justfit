# JustFit å¼€å‘å¿«é€Ÿå‚è€ƒå¡

> **æœ€åæ›´æ–°**: 2026-02-08

---

## ğŸ¯ æ•°æ®é‡‡é›†é€ŸæŸ¥

### vCenter æ•°æ®ç‰¹ç‚¹

| æŒ‡æ ‡ç±»å‹ | æ•°æ®æ ¼å¼ | æ•°æ®ç²’åº¦ | å†å²èŒƒå›´ |
|---------|---------|---------|---------|
| CPU | MHz (ç»å¯¹å€¼) | 7å¤©å†…åˆ†é’Ÿçº§<br>30å¤©å†…å°æ—¶çº§<br>1å¹´å†…å¤©çº§ | 1å¹´ |
| å†…å­˜ | Bytes (ç»å¯¹å€¼) | åŒä¸Š | 1å¹´ |
| ç£ç›˜IO | IOPS | åŒä¸Š | 1å¹´ |
| ç½‘ç»œ | KB/s | åŒä¸Š | 1å¹´ |

**å…³é”®API**: `PerformanceManager.QueryPerf()`  
**SDK**: `github.com/vmware/govmomi`

### H3C UIS æ•°æ®ç‰¹ç‚¹

| æŒ‡æ ‡ç±»å‹ | æ•°æ®æ ¼å¼ | æ•°æ®ç²’åº¦ | å†å²èŒƒå›´ |
|---------|---------|---------|---------|
| CPU | % (ç™¾åˆ†æ¯”) | å°æ—¶çº§ï¼ˆè¿”å›min/avg/maxï¼‰ | 30å¤© |
| å†…å­˜ | % (ç™¾åˆ†æ¯”) | å°æ—¶çº§ï¼ˆè¿”å›min/avg/maxï¼‰ | 30å¤© |
| ç£ç›˜IO | IOPS/MB/s | å°æ—¶çº§ | 30å¤© |
| ç½‘ç»œ | KB/s | å°æ—¶çº§ | 30å¤© |

**å…³é”®API**: `/uis/uis/report/cpuMemVm`, `/uis/uis/report/diskVm`, `/uis/uis/report/netSpVm`  
**åè®®**: HTTP REST API + Cookie Session

---

## ğŸ“Š æ•°æ®æ ‡å‡†åŒ–è§„åˆ™

### å•ä½è½¬æ¢

| æŒ‡æ ‡ | vCenter â†’ æ ‡å‡† | UIS â†’ æ ‡å‡† |
|------|---------------|-----------|
| CPU | `MHz / CpuMhz â†’ Cores` | `% â†’ %` (ä¿æŒ) |
| å†…å­˜ | `Bytes / (1024*1024) â†’ MB` | `% â†’ %` (ä¿æŒ) |
| ç£ç›˜ | `IOPS â†’ IOPS` | `IOPS â†’ IOPS` |
| ç½‘ç»œ | `KB/s â†’ KB/s` | `KB/s â†’ KB/s` |

### åŒæ ¼å¼è®¡ç®—

```go
// vCenter: å·²çŸ¥ç»å¯¹å€¼ï¼Œè®¡ç®—ç™¾åˆ†æ¯”
percentage = (absoluteValue / configValue) * 100

// UIS: å·²çŸ¥ç™¾åˆ†æ¯”ï¼Œè®¡ç®—ç»å¯¹å€¼
absoluteValue = (percentage / 100) * configValue
```

### å­˜å‚¨æ ¼å¼

```sql
-- metrics è¡¨å­—æ®µ
absolute_value REAL   -- ç»å¯¹å€¼ (Cores/MB/IOPS/KB/s)
percentage REAL       -- ç™¾åˆ†æ¯” (%)
granularity TEXT      -- 'minute', 'hour', 'day'
source_platform TEXT  -- 'vcenter', 'uis'
quality_score REAL    -- 0-100
```

---

## ğŸ¤– ç®—æ³•é…ç½®é€ŸæŸ¥

### 4ç§åˆ†ææ¨¡å¼å‚æ•°å¯¹æ¯”

#### åƒµå°¸VMæ£€æµ‹

| å‚æ•° | å®‰å…¨æ¨¡å¼ | èŠ‚çœæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ | æ¿€è¿›æ¨¡å¼ |
|------|---------|-----------------|---------|
| åˆ†æçª—å£ | 30å¤© | 14å¤© | 7å¤© |
| CPUé˜ˆå€¼ | 3% | 5% | 10% |
| å†…å­˜é˜ˆå€¼ | 5% | 10% | 15% |
| æœ€å°ç½®ä¿¡åº¦ | 95åˆ† | 85åˆ† | 75åˆ† |

#### Right Sizeè¯„ä¼°

| å‚æ•° | å®‰å…¨æ¨¡å¼ | èŠ‚çœæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ | æ¿€è¿›æ¨¡å¼ |
|------|---------|-----------------|---------|
| åˆ†æçª—å£ | 30å¤© | 14å¤© | 7å¤© |
| ç™¾åˆ†ä½ | P95 | P90 | P85 |
| ç¼“å†²æ¯”ä¾‹ | 1.30å€ | 1.20å€ | 1.10å€ |
| æ‰©å®¹é˜ˆå€¼ | >90% | >85% | >80% |
| ç¼©å®¹é˜ˆå€¼ | <40% | <50% | <60% |

#### æ½®æ±æ£€æµ‹

| å‚æ•° | å®‰å…¨æ¨¡å¼ | èŠ‚çœæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ | æ¿€è¿›æ¨¡å¼ |
|------|---------|-----------------|---------|
| åˆ†æçª—å£ | 60å¤© | 30å¤© | 14å¤© |
| ç¨³å®šæ€§è¯„åˆ† | â‰¥80 | â‰¥70 | â‰¥60 |
| æœ€å°å˜åŒ–å¹…åº¦ | 50% | 40% | 30% |

### é…ç½®ä»£ç ç¤ºä¾‹

```go
// åˆ›å»ºèŠ‚çœæ¨¡å¼é…ç½®ï¼ˆé»˜è®¤ï¼‰
factory := NewConfigFactory()
config := factory.CreateConfig(ModeCostSaving, 14)

// ä½¿ç”¨é…ç½®
zombieResults, _ := engine.DetectZombieVMs(connectionID, config.ZombieVM)
rightSizeResults, _ := engine.AnalyzeRightSize(connectionID, config.RightSize)
```

---

## ğŸ“ å…³é”®ç®—æ³•å…¬å¼

### åƒµå°¸VMç½®ä¿¡åº¦

```
æ€»åˆ† = CPUè¯„åˆ†(40åˆ†) + å†…å­˜è¯„åˆ†(30åˆ†) + ç£ç›˜IOè¯„åˆ†(15åˆ†) + ç½‘ç»œè¯„åˆ†(15åˆ†) + æŒç»­æ€§åŠ æˆ(æœ€å¤š10åˆ†)

CPUè¯„åˆ†:
  - ä½¿ç”¨ç‡ â‰¤ é˜ˆå€¼*0.5: 40åˆ†
  - ä½¿ç”¨ç‡ â‰¤ é˜ˆå€¼*0.8: 35åˆ†
  - ä½¿ç”¨ç‡ â‰¤ é˜ˆå€¼: 25åˆ†

æŒç»­æ€§åŠ æˆ:
  - ä½è´Ÿè½½å¤©æ•°æ¯”ä¾‹ â‰¥ 95%: +10åˆ†
  - ä½è´Ÿè½½å¤©æ•°æ¯”ä¾‹ â‰¥ 90%: +8åˆ†
  - ä½è´Ÿè½½å¤©æ•°æ¯”ä¾‹ â‰¥ 85%: +6åˆ†
```

### Right Sizeæ¨èé…ç½®

```
æ¨èCPU = Ceiling((På€¼ä½¿ç”¨ç‡ / 100) Ã— å½“å‰CPU Ã— ç¼“å†²æ¯”ä¾‹)
æ¨èå†…å­˜ = Ceiling((På€¼ä½¿ç”¨ç‡ / 100) Ã— å½“å‰å†…å­˜ Ã— ç¼“å†²æ¯”ä¾‹)

ä¾‹å¦‚ï¼ˆèŠ‚çœæ¨¡å¼ï¼‰:
  å½“å‰: 4æ ¸, P90ä½¿ç”¨ç‡: 60%, ç¼“å†²: 1.2å€
  æ¨è = Ceiling(4 Ã— 0.6 Ã— 1.2) = Ceiling(2.88) = 3æ ¸
```

### ç™¾åˆ†ä½æ•°è®¡ç®—

```go
// çº¿æ€§æ’å€¼æ³•
index = (p / 100) * (n - 1)
lower = Floor(index)
upper = Ceiling(index)

if lower == upper:
    return sorted[lower]
else:
    weight = index - lower
    return sorted[lower]*(1-weight) + sorted[upper]*weight
```

### é£é™©è¯„ä¼°

```
é£é™©åˆ†æ•° = 0
IF CPUå˜å¼‚ç³»æ•° > é˜ˆå€¼: +2
IF å†…å­˜å˜å¼‚ç³»æ•° > é˜ˆå€¼: +2
IF å³°å€¼ - P95 > 20%: +1
IF æ¨èå€¼ < å³°å€¼*1.1: +2
IF æ ·æœ¬æ•° < æœŸæœ›50%: +1

é£é™©ç­‰çº§:
  â‰¥4åˆ†: é«˜é£é™©
  â‰¥2åˆ†: ä¸­é£é™©
  <2åˆ†: ä½é£é™©
```

---

## ğŸ”§ æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

### æ‰¹é‡æŸ¥è¯¢æŒ‡æ ‡

```go
// âŒ ä½æ•ˆï¼šé€VMæŸ¥è¯¢
for _, vm := range vms {
    metrics := repo.QueryMetrics(vm.ID, "cpu", start, end)
}

// âœ… é«˜æ•ˆï¼šæ‰¹é‡æŸ¥è¯¢
vmIDs := extractVMIDs(vms)
allMetrics := repo.BatchQueryMetrics(vmIDs, []string{"cpu", "memory"}, start, end)
metricsByVM := groupMetricsByVM(allMetrics)
```

### é€‰æ‹©åˆé€‚çš„æ•°æ®ç²’åº¦

```go
func determineGranularity(days int) string {
    if days <= 7 {
        return "minute"  // åˆ†é’Ÿçº§ï¼Œé«˜ç²¾åº¦
    } else if days <= 90 {
        return "hour"    // å°æ—¶çº§ï¼Œå¹³è¡¡
    } else {
        return "day"     // å¤©çº§ï¼Œé•¿æœŸè¶‹åŠ¿
    }
}
```

### ç´¢å¼•ä½¿ç”¨

```sql
-- å…³é”®ç´¢å¼•
CREATE INDEX idx_metrics_vm_type_time 
ON metrics(vm_id, metric_type, timestamp);

CREATE INDEX idx_metrics_vm_type_granularity 
ON metrics(vm_id, metric_type, granularity, timestamp);

-- æŸ¥è¯¢ç¤ºä¾‹ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
SELECT * FROM metrics 
WHERE vm_id = ? 
  AND metric_type = 'cpu' 
  AND granularity = 'hour'
  AND timestamp BETWEEN ? AND ?
ORDER BY timestamp;
```

---

##  å¸¸è§é—®é¢˜é€ŸæŸ¥

### Q1: æ•°æ®ç¼ºå¤±æ€ä¹ˆåŠï¼Ÿ

```go
// æ£€æŸ¥æ ·æœ¬æ•°é‡
expectedSamples := config.AnalysisDays * 24 * 3
if len(metrics) < expectedSamples / 10 {  // < 10%æœŸæœ›å€¼
    log.Warn("æ•°æ®ä¸è¶³ï¼Œè·³è¿‡åˆ†æ")
    continue
}

// æ£€æŸ¥æ•°æ®è´¨é‡
avgQuality := CalculateAvgQuality(metrics)
if avgQuality < 60 {
    log.Warn("æ•°æ®è´¨é‡ä½ï¼Œè·³è¿‡åˆ†æ")
    continue
}
```

### Q2: å¼‚å¸¸å€¼å¦‚ä½•è¿‡æ»¤ï¼Ÿ

```go
// CPUç™¾åˆ†æ¯”è¶…è¿‡200%å¯èƒ½æ˜¯å¼‚å¸¸
filtered := []float64{}
for _, metric := range metrics {
    if metric.Percentage <= 200 && metric.Percentage >= 0 {
        filtered = append(filtered, metric.Percentage)
    }
}
```

### Q3: å¦‚ä½•å¤„ç†æ–°å»ºVMï¼Ÿ

```go
// æ’é™¤è¿‘æœŸåˆ›å»ºçš„VM
if vm.CreatedAt != nil {
    daysSinceCreated := time.Since(*vm.CreatedAt).Hours() / 24
    if daysSinceCreated < float64(config.ExcludeRecentStarted) {
        continue
    }
}
```

### Q4: ä¸åŒä¸šåŠ¡ç±»å‹å¦‚ä½•å·®å¼‚åŒ–ï¼Ÿ

```go
func ApplyBusinessTypeStrategy(vm *VM, baseConfig *Config) *Config {
    switch IdentifyBusinessType(vm) {
    case "database":
        config.BufferRatio = 1.30  // æ•°æ®åº“æ›´ä¿å®ˆ
    case "web_server":
        config.BufferRatio = 1.15  // Webå¯é€‚åº¦æ¿€è¿›
    case "dev_test":
        config.BufferRatio = 1.05  // æµ‹è¯•ç¯å¢ƒéå¸¸æ¿€è¿›
    }
    return config
}
```

---

## ğŸ“š æ–‡æ¡£å¿«é€Ÿè·³è½¬

| éœ€è¦äº†è§£... | æŸ¥çœ‹æ–‡æ¡£ | ç« èŠ‚ |
|-----------|---------|------|
| æ•°æ®é‡‡é›†å®ç° | æ•°æ®æµä¸æ ‡å‡†åŒ–è®¾è®¡.md | Â§2 |
| æ•°æ®æ ‡å‡†åŒ–é€»è¾‘ | æ•°æ®æµä¸æ ‡å‡†åŒ–è®¾è®¡.md | Â§3 |
| åŒæ ¼å¼å­˜å‚¨è®¾è®¡ | æ•°æ®æµä¸æ ‡å‡†åŒ–è®¾è®¡.md | Â§4 |
| 4ç§åˆ†ææ¨¡å¼ | ç®—æ³•é…ç½®ç³»ç»Ÿè®¾è®¡.md | Â§2 |
| é…ç½®ç®¡ç†å®ç° | ç®—æ³•é…ç½®ç³»ç»Ÿè®¾è®¡.md | Â§3 |
| åƒµå°¸VMç®—æ³• | ç®—æ³•è¯¦ç»†å®æ–½æ‰‹å†Œ.md | Â§1 |
| Right Sizeç®—æ³• | ç®—æ³•è¯¦ç»†å®æ–½æ‰‹å†Œ.md | Â§2 |
| æ€§èƒ½ä¼˜åŒ– | ç®—æ³•è¯¦ç»†å®æ–½æ‰‹å†Œ.md | Â§1.6 |

---

## ğŸš¦ å¸¸ç”¨ä»£ç ç‰‡æ®µ

### åˆ›å»ºåˆ†æå¼•æ“

```go
repos := storage.NewRepositories(db)
engine := analyzer.NewEngine(repos)

factory := analyzer.NewConfigFactory()
config := factory.CreateConfig(analyzer.ModeCostSaving, 14)

results, err := engine.DetectZombieVMs(connectionID, config.ZombieVM)
```

### å¹¶å‘å¤„ç†VM

```go
jobs := make(chan storage.VM, len(vms))
results := make(chan *Result, len(vms))

workerCount := runtime.NumCPU()
var wg sync.WaitGroup

for i := 0; i < workerCount; i++ {
    wg.Add(1)
    go func() {
        defer wg.Done()
        for vm := range jobs {
            result, _ := analyzeVM(vm, config)
            results <- result
        }
    }()
}

for _, vm := range vms {
    jobs <- vm
}
close(jobs)

go func() {
    wg.Wait()
    close(results)
}()

for result := range results {
    // å¤„ç†ç»“æœ
}
```

### è®¡ç®—ç»Ÿè®¡å€¼

```go
// ç™¾åˆ†ä½
p95 := analyzer.Percentile(values, 95)

// å¹³å‡å€¼
avg := analyzer.Average(values)

// å˜å¼‚ç³»æ•°
cv := analyzer.CoefficientOfVariation(values)

// æ ‡å‡†å·®
stdDev := analyzer.StandardDeviation(values)
```

---

**ç‰ˆæœ¬**: v1.0  
**ç»´æŠ¤**: JustFit å¼€å‘å›¢é˜Ÿ  
**åé¦ˆ**: å‘ç°é—®é¢˜è¯·åŠæ—¶æ›´æ–°æ­¤æ–‡æ¡£

