# 测试执行指南

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 测试执行指南 |
| 版本 | v0.0.2 |
| 日期 | 2026-02-24 |
| 状态 | 可执行 |

---

## 1. 快速开始

### 1.1 运行单元测试（已完成）

```bash
# 进入项目目录
cd /home/devbox/project/justfit

# 运行单元测试
go test -v ./test/unit/logger/... ./test/unit/errors/...

# 预期输出：所有测试 PASS
# ok  	justfit/test/unit/logger	0.004s
# ok  	justfit/test/unit/errors	0.004s
```

### 1.2 运行基准测试

```bash
go test -bench=. -benchmem ./test/unit/logger/...
```

---

## 2. 测试结果验证

### 2.1 已完成的测试

| 测试文件 | 测试用例数 | 状态 |
|---------|----------|------|
| logger_test.go | 11 | PASS |
| errors_test.go | 13 | PASS |

### 2.2 测试覆盖的功能点

**日志系统测试**:
- [x] 日志级别解析
- [x] 日志级别过滤
- [x] 结构化字段记录
- [x] 子日志器（预设字段）
- [x] 错误字段处理
- [x] 运行时级别修改
- [x] 字段辅助函数

**错误处理测试**:
- [x] 错误创建与格式化
- [x] 错误包装与解包
- [x] 错误匹配（Is 方法）
- [x] 预定义错误
- [x] 错误链处理
- [x] 错误类型判断（NotFound, Timeout）
- [x] 错误码获取

---

## 3. 手动验证步骤

### 3.1 验证日志输出

创建测试文件 `test_log_manual.go`:

```go
package main

import (
    "justfit/internal/logger"
)

func main() {
    // 初始化日志器
    logger.Init(&logger.Config{
        Level:   logger.DEBUG,
        Outputs: []logger.Output{
            logger.NewConsoleOutput(logger.FormatText),
        },
    })

    // 测试各级别日志
    logger.Debug("这是一条调试消息",
        logger.String("component", "test"),
        logger.Int("count", 100))

    logger.Info("这是一条信息消息",
        logger.String("status", "ok"))

    logger.Warn("这是一条警告消息",
        logger.String("issue", "high memory"))

    logger.Error("这是一条错误消息",
        logger.String("error", "connection failed"))

    // 测试子日志器
    taskLog := logger.With(
        logger.String("task_id", "12345"),
        logger.String("task_type", "collection"),
    )

    taskLog.Info("任务开始执行")
    taskLog.Info("任务执行完成", logger.Int("processed", 50))

    // 同步并关闭
    logger.Sync()
    logger.Close()
}
```

运行验证:
```bash
go run test_log_manual.go
```

**预期输出**:
```
[DEBUG] 测试日志消息 component=test count=100
[INFO] 这是一条信息消息 status=ok
[WARN] 这是一条警告消息 issue=high memory
[ERROR] 这是一条错误消息 error=connection failed
[INFO] 任务开始执行 task_id=12345 task_type=collection
[INFO] 任务执行完成 task_id=12345 task_type=collection processed=50
```

### 3.2 验证错误处理

创建测试文件 `test_error_manual.go`:

```go
package main

import (
    "fmt"
    stderrors "errors"

    apperrors "justfit/internal/errors"
)

func main() {
    // 创建错误
    err := apperrors.ErrInvalidInput

    fmt.Println("=== 基础错误 ===")
    fmt.Println(err.Error())

    // 包装错误
    fmt.Println("\n=== 包装错误 ===")
    original := stderrors.New("原始错误")
    wrapped := apperrors.Wrap("TASK_FAILED", "任务执行失败", original)
    fmt.Println(wrapped.Error())
    fmt.Println("错误码:", apperrors.GetCode(wrapped))

    // 错误判断
    fmt.Println("\n=== 错误类型判断 ===")
    fmt.Println("IsNotFound:", apperrors.IsNotFound(apperrors.ErrNotFound))
    fmt.Println("IsNotFound:", apperrors.IsNotFound(apperrors.ErrInternal))

    // 错误链
    fmt.Println("\n=== 错误链 ===")
    chain := apperrors.FormatErrorChain(wrapped)
    fmt.Println(chain)
}
```

运行验证:
```bash
go run test_error_manual.go
```

---

## 4. 集成测试（待实现）

当前集成测试框架已建立，但测试用例尚未编写。实现计划：

1. **数据库测试** - 验证 SQLite 连接和表创建
2. **仓储测试** - 验证 CRUD 操作
3. **连接器测试** - 需要 mock vCenter/UIS 响应

---

## 5. 将测试结果反馈给开发

### 5.1 测试反馈表

```markdown
# 测试反馈

## 环境信息
- 操作系统: [Linux/Mac/Windows]
- Go 版本: [go version 输出]
- 测试时间: [日期时间]

## 单元测试结果
- [x] logger_test.go - 全部 PASS
- [x] errors_test.go - 全部 PASS

## 手动验证结果
- [ ] 日志输出正常
- [ ] 错误处理正常

## 发现的问题
[描述发现的问题，如果有的话]

## 建议
[你的建议]
```

### 5.2 收集日志信息

如果测试失败，请提供：

1. 完整的错误输出
2. Go 版本信息 (`go version`)
3. 操作系统信息 (`uname -a` 或系统信息)
4. 相关的日志文件

---

## 6. 常见问题

### Q1: 测试编译失败

**A**: 确保在项目根目录运行测试，并且 Go 版本 >= 1.24

### Q2: 导入路径错误

**A**: 确保 `go.mod` 中的模块名是 `justfit`

### Q3: 日志无输出

**A**: 检查日志级别设置，DEBUG 级别最低，ERROR 级别最高
