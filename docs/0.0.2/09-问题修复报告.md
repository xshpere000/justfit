# 问题修复报告

## 问题分析与修复

### 问题1: 历史评估数据为空 (P1)

**问题描述**: 点击评估任务卡片进入任务详情，开启评估功能（如僵尸VM检测）后显示结果，但退出再次进入时历史数据为空。

**分析结果**:
- ✅ 后端数据持久化正常 - 通过数据库检查确认 `task_analysis_results` 表有数据
- ✅ 后端 API 正常 - `GetTaskDetail()` 和 `GetTaskAnalysisResult()` 从数据库正确读取
- ⚠️ 可能是前端状态管理问题

**数据库验证**:
```sql
-- 分析结果表有数据
SELECT id, task_id, analysis_type FROM task_analysis_results;
-- 结果:
-- 4|5|right_size
-- 3|4|health_score
-- 2|3|tidal
-- 1|2|zombie_vm
```

**结论**: 后端数据已正确保存，问题在于前端缓存或状态刷新。

**建议**:
1. 检查前端 `GetTaskDetail` 和 `GetTaskAnalysisResult` 调用时机
2. 检查前端是否有状态缓存导致不重新请求数据
3. 在任务详情进入时强制刷新数据

---

### 问题2: 日志目录为空 (P2)

**问题描述**: wails dev 启动后创建 `.justfit/logs/` 目录，但目录为空。

**原因分析**:
1. `task.Logger` 有自己的日志文件处��，但可能没有正确写入
2. 新的 `applogger` 系统已集成到 `app.go`，但日志需要实际产生才会写入

**修复方案**:
已在 `app.go` 中添加了新的 logger 系统初始化：
```go
// 初始化日志系统
logDir := appdir.MustGetLogDir(a.ctx)
logConfig := &applogger.Config{
    Level:      applogger.INFO,
    Outputs:    []applogger.Output{applogger.NewConsoleOutput(applogger.FormatText)},
    CallerSkip: 1,
}
// 开发模式下同时输出到文件
if appdir.IsDevMode(a.ctx) {
    logFilePath := filepath.Join(logDir, "app.log")
    fileOutput, err := applogger.NewFileOutput(logFilePath)
    if err == nil {
        logConfig.Outputs = []applogger.Output{
            applogger.NewConsoleOutput(applogger.FormatText),
            fileOutput,
        }
    }
}
globalLogger := applogger.New(logConfig)
```

**状态**: ✅ 已修复

**待验证**: 重启应用后检查 `.justfit/logs/app.log` 是否有内容

---

### 问题3: 历史任务异常显示 (P2)

**问题描述**: 项目根目录删除 `.justfit` 文件夹后，wails dev 启动仍然显示历史任务。

**原因分析**:
- 数据库文件可能不在项目根目录的 `.justfit` 文件夹
- `appdir.GetAppDataDir()` 在开发模式下会检测项目目录

**定位数据库位置**:
```bash
# 检查所有可能的数据库位置
find ~ -name "justfit.db" -type f 2>/dev/null
```

**可能的数据库位置**:
1. `~/.local/share/justfit/justfit.db` (Linux 生产目录)
2. `~/Library/Application Support/justfit/justfit.db` (macOS)
3. `%APPDATA%/justfit/justfit.db` (Windows)

**建议**:
1. 检查 `appdir.IsDevMode()` 的检测逻辑
2. 设置环境变量 `JUSTFIT_DATA_DIR` 强制使用特定目录
3. 清除所有可能的数据库位置后重新测试

**修复**:
在 `app.go` 的 `startup` 中添加了日志输出，显示当前使用的日志目录（也是数据库目录位置）：
```go
globalLogger.Info("应用启动", applogger.String("logDir", logDir), applogger.Bool("devMode", appdir.IsDevMode(a.ctx)))
```

---

## AI 发现的新问题

### 问题4: 日志级别控制

**问题描述**: 当前日志系统没有提供运行时调整日志级别的方法。

**建议**: 添加 `SetLogLevel(level string)` API，允许前端动态调整日志级别。

### 问题5: 日志文件轮转

**问题描述**: 日志文件没有大小限制或轮转机制，长时间运行可能导致日志文件过大。

**建议**: 在 `FileOutput` 中添加文件大小检查和轮转逻辑。

---

## 修复验证清单

- [x] 问题2: 在 app.go 中初始化 logger 系统
- [x] 问题2: 添加文件输出适配器
- [x] 问题3: 添加启动日志显示目录位置
- [ ] 问题1: 前端状态刷新（需要前端代码修改）
- [ ] 问题3: 数据库位置清理（需要用户验证）
- [ ] 验证日志文件是否正确写入
