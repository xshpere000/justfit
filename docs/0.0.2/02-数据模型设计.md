# JustFit v0.0.2 数据模型设计

## 文档信息

| 项目 | 内容 |
|------|------|
| 文档名称 | 数据模型设计 |
| 版本 | v0.0.2 |
| 日期 | 2026-02-24 |
| 前置文档 | 01-操作方案.md |

---

## 1. 设计原则

1. **分层清晰**：数据库模型 ← 领域模型 ← DTO，每层职责明确
2. **命名统一**：后端 `snake_case` JSON 输出，前端 `camelCase` 接收
3. **类型安全**：使用强类型，避免 `interface{}`
4. **可测试性**：模型与数据库无关，便于单元测试

---

## 2. 层次架构

```
┌─────────────────────────────────────────────────────────────┐
│                      DTO 层 (API)                           │
│              internal/dto/request & response               │
│                 └─ JSON Tag: snake_case                    │
├─────────────────────────────────────────────────────────────┤
│                   Mapper 层 (转换)                          │
│                   internal/dto/mapper                       │
│                 └─ 双向转换：Model ↔ DTO                    │
├─────────────────────────────────────────────────────────────┤
│                  领域模型层 (业务)                          │
│                   internal/domain/entity                    │
│                 └─ 纯业务逻辑，无持久化细节                  │
├─────────────────────────────────────────────────────────────┤
│                  数据模型层 (存储)                          │
│                   internal/storage/models                  │
│                 └─ GORM 注解，数据库表结构                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. DTO 层设计

### 3.1 通用响应结构

```go
// internal/dto/response/common.go

package response

import "time"

// Response 标准 API 响应
type Response[T any] struct {
    Success bool   `json:"success" example:"true"`
    Data    T      `json:"data,omitempty"`
    Message string `json:"message,omitempty" example:"操作成功"`
    Error   string `json:"error,omitempty"`
    Code    string `json:"code,omitempty"`     // 业务错误码
    TraceID string `json:"trace_id,omitempty"` // 链路追踪ID
}

// PagedResponse 分页响应
type PagedResponse[T any] struct {
    Total  int64 `json:"total" example:"100"`
    Page   int   `json:"page" example:"1"`
    Size   int   `json:"size" example:"20"`
    Items  []T   `json:"items"`
}

// StatusResponse 状态响应
type StatusResponse struct {
    Status    string `json:"status"`
    UpdatedAt string `json:"updated_at"`
}

// 新建响应的辅助函数
func NewSuccessResponse[T any](data T) *Response[T] {
    return &Response[T]{Success: true, Data: data}
}

func NewErrorResponse(code, message string) *Response[any] {
    return &Response[any]{
        Success: false,
        Error:   message,
        Code:    code,
    }
}

func NewPagedResponse[T any](total int64, page, size int, items []T) *PagedResponse[T] {
    return &PagedResponse[T]{
        Total: total,
        Page:  page,
        Size:  size,
        Items: items,
    }
}
```

### 3.2 连接相关 DTO

#### 请求 DTO

```go
// internal/dto/request/connection.go

package request

import "github.com/go-playground/validator/v10"

var validate = validator.New()

// Request 请求基础接口
type Request interface {
    Validate() error
}

// CreateConnectionRequest 创建连接请求
type CreateConnectionRequest struct {
    Name     string `json:"name" validate:"required,min=1,max=100"`
    Platform string `json:"platform" validate:"required,oneof=vcenter h3c-uis"`
    Host     string `json:"host" validate:"required,ip|hostname"`
    Port     int    `json:"port" validate:"required,min=1,max=65535"`
    Username string `json:"username" validate:"required,min=1,max=100"`
    Password string `json:"password" validate:"required,min=1"`
    Insecure bool   `json:"insecure"`
}

func (r *CreateConnectionRequest) Validate() error {
    return validate.Struct(r)
}

// UpdateConnectionRequest 更新连接请求
type UpdateConnectionRequest struct {
    ID       uint   `json:"id" validate:"required"`
    Name     string `json:"name" validate:"required,min=1,max=100"`
    Host     string `json:"host" validate:"required,ip|hostname"`
    Port     int    `json:"port" validate:"required,min=1,max=65535"`
    Username string `json:"username" validate:"required,min=1,max=100"`
    Password string `json:"password" validate:"omitempty,min=1"` // 可选
    Insecure bool   `json:"insecure"`
}

func (r *UpdateConnectionRequest) Validate() error {
    return validate.Struct(r)
}

// TestConnectionRequest 测试连接请求
type TestConnectionRequest struct {
    ID     uint   `json:"id" validate:"required"`
    Host   string `json:"host" validate:"required"`
    Port   int    `json:"port" validate:"required"`
    UseSSL bool   `json:"use_ssl"`
}

func (r *TestConnectionRequest) Validate() error {
    return validate.Struct(r)
}
```

#### 响应 DTO

```go
// internal/dto/response/connection.go

package response

import "time"

// ConnectionResponse 连接响应
type ConnectionResponse struct {
    ID        uint       `json:"id"`
    Name      string     `json:"name"`
    Platform  string     `json:"platform"`
    Host      string     `json:"host"`
    Port      int        `json:"port"`
    Username  string     `json:"username"`
    Insecure  bool       `json:"insecure"`
    Status    string     `json:"status"`
    CreatedAt time.Time  `json:"created_at"`
    LastSync  *time.Time `json:"last_sync,omitempty"`
}

// ConnectionListItem 连接列表项
type ConnectionListItem struct {
    ID        uint    `json:"id"`
    Name      string  `json:"name"`
    Platform  string  `json:"platform"`
    Host      string  `json:"host"`
    Status    string  `json:"status"`
    VMCount   int     `json:"vm_count"`
    LastSync  *string `json:"last_sync,omitempty"`
}
```

### 3.3 资源相关 DTO

```go
// internal/dto/response/resource.go

package response

import "time"

// VMResponse 虚拟机响应
type VMResponse struct {
    ID            uint      `json:"id"`
    Name          string    `json:"name"`
    Datacenter    string    `json:"datacenter"`
    UUID          string    `json:"uuid"`
    CPUCount      int32     `json:"cpu_count"`
    MemoryMB      int32     `json:"memory_mb"`
    MemoryGB      float64   `json:"memory_gb"`      // 派生字段
    PowerState    string    `json:"power_state"`
    IPAddress     string    `json:"ip_address,omitempty"`
    GuestOS       string    `json:"guest_os,omitempty"`
    HostName      string    `json:"host_name,omitempty"`
    OverallStatus string    `json:"overall_status,omitempty"`
    CollectedAt   time.Time `json:"collected_at"`
}

// HostResponse 主机响应
type HostResponse struct {
    ID            uint      `json:"id"`
    Name          string    `json:"name"`
    Datacenter    string    `json:"datacenter"`
    IPAddress     string    `json:"ip_address"`
    CPUCores      int32     `json:"cpu_cores"`
    CPUMHz        int32     `json:"cpu_mhz"`
    MemoryMB      int64     `json:"memory_mb"`
    MemoryGB      float64   `json:"memory_gb"`
    NumVMs        int       `json:"num_vms"`
    PowerState    string    `json:"power_state"`
    OverallStatus string    `json:"overall_status"`
    CollectedAt   time.Time `json:"collected_at"`
}

// ClusterResponse 集群响应
type ClusterResponse struct {
    ID           uint      `json:"id"`
    Name         string    `json:"name"`
    Datacenter   string    `json:"datacenter"`
    TotalCPU     int64     `json:"total_cpu"`
    TotalMemory  int64     `json:"total_memory"`
    TotalMemoryGB float64  `json:"total_memory_gb"`
    NumHosts     int32     `json:"num_hosts"`
    NumVMs       int       `json:"num_vms"`
    Status       string    `json:"status"`
    CollectedAt  time.Time `json:"collected_at"`
}

// MetricPoint 指标数据点
type MetricPoint struct {
    Timestamp int64   `json:"timestamp"`
    Value     float64 `json:"value"`
}

// MetricsResponse 指标响应
type MetricsResponse struct {
    VMID       uint          `json:"vm_id"`
    VMName     string        `json:"vm_name"`
    MetricType string        `json:"metric_type"` // cpu, memory, disk_read, disk_write, net_rx, net_tx
    StartTime  string        `json:"start_time"`
    EndTime    string        `json:"end_time"`
    DataPoints []MetricPoint `json:"data_points"`
}
```

### 3.4 任务相关 DTO

```go
// internal/dto/request/task.go

package request

// CreateCollectionTaskRequest 创建采集任务请求
type CreateCollectionTaskRequest struct {
    ConnectionID   uint     `json:"connection_id" validate:"required"`
    SelectedVMs    []string `json:"selected_vms"`
    DataTypes      []string `json:"data_types" validate:"required,dive,oneof=clusters hosts vms metrics"`
    MetricsDays    int      `json:"metrics_days" validate:"min=1,max=365"`
    Concurrency    int      `json:"concurrency" validate:"min=1,max=10"`
}

func (r *CreateCollectionTaskRequest) Validate() error {
    return validate.Struct(r)
}

// CreateAnalysisTaskRequest 创建分析任务请求
type CreateAnalysisTaskRequest struct {
    ConnectionID  uint                   `json:"connection_id" validate:"required"`
    AnalysisTypes []string               `json:"analysis_types" validate:"required,dive,oneof=zombie_vm right_size tidal health_score"`
    Config        map[string]interface{} `json:"config"`
}

func (r *CreateAnalysisTaskRequest) Validate() error {
    return validate.Struct(r)
}

// ListTasksRequest 查询任务列表请求
type ListTasksRequest struct {
    Type   string `json:"type" validate:"omitempty,oneof=collection analysis report"`
    Status string `json:"status" validate:"omitempty,oneof=pending running completed failed cancelled"`
    Limit  int    `json:"limit" validate:"omitempty,min=1,max=100"`
    Offset int    `json:"offset" validate:"omitempty,min=0"`
}

func (r *ListTasksRequest) Validate() error {
    return validate.Struct(r)
}
```

```go
// internal/dto/response/task.go

package response

import "time"

// TaskResponse 任务响应
type TaskResponse struct {
    ID            uint       `json:"id"`
    Type          string     `json:"type"`
    Name          string     `json:"name"`
    Status        string     `json:"status"`
    Progress      int        `json:"progress"`
    Error         string     `json:"error,omitempty"`
    CreatedAt     time.Time  `json:"created_at"`
    StartedAt     *time.Time `json:"started_at,omitempty"`
    CompletedAt   *time.Time `json:"completed_at,omitempty"`
    DurationMs    int64      `json:"duration_ms,omitempty"` // 执行时长（毫秒）
    // 扩展字段
    ConnectionID   uint   `json:"connection_id,omitempty"`
    ConnectionName string `json:"connection_name,omitempty"`
    Platform       string `json:"platform,omitempty"`
    TotalVMs      int32  `json:"total_vms,omitempty"`
    CollectedVMs  int32  `json:"collected_vms,omitempty"`
}

// TaskDetailResponse 任务详情响应
type TaskDetailResponse struct {
    TaskResponse
    CurrentStep     string                 `json:"current_step,omitempty"`
    Config          map[string]interface{} `json:"config,omitempty"`
    Result          map[string]interface{} `json:"result,omitempty"`
    AnalysisResults map[string]bool        `json:"analysis_results,omitempty"` // zombie: true, rightsize: false
}

// TaskLogEntry 任务日志条目
type TaskLogEntry struct {
    Timestamp string                 `json:"timestamp"` // ISO 8601
    Level     string                 `json:"level"`     // info, warning, error
    Message   string                 `json:"message"`
    Fields    map[string]interface{} `json:"fields,omitempty"`
}
```

### 3.5 分析相关 DTO

```go
// internal/dto/request/analysis.go

package request

// ZombieVMAnalysisConfig 僵尸 VM 分析配置
type ZombieVMAnalysisConfig struct {
    AnalysisDays    int     `json:"analysis_days" validate:"min=1,max=365"`
    CPUThreshold    float64 `json:"cpu_threshold" validate:"min=0,max=100"`
    MemoryThreshold float64 `json:"memory_threshold" validate:"min=0,max=100"`
    MinConfidence   float64 `json:"min_confidence" validate:"min=0,max=100"`
}

// RightSizeAnalysisConfig Right Size 分析配置
type RightSizeAnalysisConfig struct {
    AnalysisDays int     `json:"analysis_days" validate:"min=1,max=365"`
    BufferRatio  float64 `json:"buffer_ratio" validate:"min=1.0,max=2.0"`
    Percentile   int     `json:"percentile" validate:"min=50,max=99"`
}

// TidalAnalysisConfig 潮汐分析配置
type TidalAnalysisConfig struct {
    AnalysisDays  int     `json:"analysis_days" validate:"min=7,max=365"`
    MinStability  float64 `json:"min_stability" validate:"min=0,max=100"`
}
```

```go
// internal/dto/response/analysis.go

package response

// ZombieVMResult 僵尸 VM 分析结果
type ZombieVMResult struct {
    VMName        string   `json:"vm_name"`
    Datacenter    string   `json:"datacenter"`
    Host          string   `json:"host"`
    CPUCount      int32    `json:"cpu_count"`
    MemoryMB      int32    `json:"memory_mb"`
    CPUUsage      float64  `json:"cpu_usage"`      // 平均 CPU 使用率 (%)
    MemoryUsage   float64  `json:"memory_usage"`   // 平均内存使用率 (%)
    DiskIORate    float64  `json:"disk_io_rate"`   // 平均磁盘 I/O
    NetworkRate   float64  `json:"network_rate"`   // 平均网络速率
    Confidence    float64  `json:"confidence"`     // 置信度 (0-100)
    DaysLowUsage  int      `json:"days_low_usage"` // 低负载天数
    Evidence      []string `json:"evidence"`       // 证据列表
    Recommendation string  `json:"recommendation"` // 建议操作
}

// RightSizeResult Right Size 分析结果
type RightSizeResult struct {
    VMName              string  `json:"vm_name"`
    Datacenter          string  `json:"datacenter"`
    CurrentCPU          int32   `json:"current_cpu"`
    CurrentMemoryMB     int32   `json:"current_memory_mb"`
    CurrentMemoryGB     float64 `json:"current_memory_gb"`
    RecommendedCPU      int32   `json:"recommended_cpu"`
    RecommendedMemoryMB int32   `json:"recommended_memory_mb"`
    RecommendedMemoryGB float64 `json:"recommended_memory_gb"`
    AdjustmentType      string  `json:"adjustment_type"` // none, up, down
    RiskLevel           string  `json:"risk_level"`      // low, medium, high
    EstimatedSaving     string  `json:"estimated_saving"` // 节省估算
    Confidence          float64 `json:"confidence"`       // 置信度
}

// TidalResult 潮汐分析结果
type TidalResult struct {
    VMName         string   `json:"vm_name"`
    Datacenter     string   `json:"datacenter"`
    Pattern        string   `json:"pattern"`         // daily, weekly, none
    StabilityScore float64  `json:"stability_score"`  // 稳定性评分
    PeakHours      []int    `json:"peak_hours"`      // 峰值小时 (0-23)
    PeakDays       []int    `json:"peak_days"`       // 峰值星期 (0-6)
    Recommendation string   `json:"recommendation"`  // 建议操作
    EstimatedSaving string  `json:"estimated_saving"` // 节省估算
}

// HealthScoreResult 健康评分结果
type HealthScoreResult struct {
    ConnectionID         uint     `json:"connection_id"`
    ConnectionName       string   `json:"connection_name"`
    OverallScore         float64  `json:"overall_score"`          // 总分 (0-100)
    HealthLevel          string   `json:"health_level"`           // excellent, good, fair, poor
    ResourceBalance      float64  `json:"resource_balance"`       // 资源均衡度
    OvercommitRisk       float64  `json:"overcommit_risk"`        // 超配风险
    HotspotConcentration float64  `json:"hotspot_concentration"` // 热点集中度
    TotalClusters        int      `json:"total_clusters"`
    TotalHosts           int      `json:"total_hosts"`
    TotalVMs             int      `json:"total_vms"`
    RiskItems            []string `json:"risk_items"`
    Recommendations      []string `json:"recommendations"`
}

// AnalysisSummary 分析汇总
type AnalysisSummary struct {
    ConnectionID  uint            `json:"connection_id"`
    TotalVMs      int64           `json:"total_vms"`
    ZombieVMs     int             `json:"zombie_vms"`
    RightSizeVMs  int             `json:"right_size_vms"`
    TidalVMs      int             `json:"tidal_vms"`
    HealthScore   float64         `json:"health_score"`
    TotalSavings  string          `json:"total_savings"`
    LastAnalyzed  string          `json:"last_analyzed"`
    RiskDistribution map[string]int `json:"risk_distribution"`
}
```

---

## 4. 领域模型层设计

```go
// internal/domain/entity/vm.go

package entity

import "time"

// VM 虚拟机领域实体
// 纯业务模型，不包含持久化细节
type VM struct {
    id          uint
    vmKey       string
    name        string
    datacenter  string
    cpu         CPU
    memory      Memory
    disk        Disk
    powerState  PowerState
    network     NetworkInfo
    guestOS     string
    hostName    string
    collectedAt time.Time
}

// NewVM 创建 VM 实体
func NewVM(vmKey, name string, cpu CPU, memory Memory) *VM {
    return &VM{
        vmKey:      vmKey,
        name:       name,
        cpu:        cpu,
        memory:     memory,
        powerState: PowerStateUnknown,
    }
}

// GetID 获取 ID
func (v *VM) GetID() uint {
    return v.id
}

// GetName 获取名称
func (v *VM) GetName() string {
    return v.name
}

// IsRunning 是否正在运行
func (v *VM) IsRunning() bool {
    return v.powerState == PowerStatePoweredOn
}

// GetMemoryGB 获取内存（GB）
func (v *VM) GetMemoryGB() float64 {
    return v.memory.ToGB()
}

// CPU CPU 值对象
type CPU struct {
    Count int32 // 核心数
    MHz   int32 // 频率
}

// TotalMHz 总 MHz
func (c CPU) TotalMHz() int64 {
    return int64(c.Count) * int64(c.MHz)
}

// Memory 内存值对象
type Memory struct {
    MB int32
}

// ToGB 转换为 GB
func (m Memory) ToGB() float64 {
    return float64(m.MB) / 1024
}

// Disk 磁盘值对象
type Disk struct {
    SizeGB   int32
    IOPS     int32
    Throughput int64 // MB/s
}

// PowerState 电源状态
type PowerState string

const (
    PowerStatePoweredOn  PowerState = "poweredOn"
    PowerStatePoweredOff PowerState = "poweredOff"
    PowerStateSuspended  PowerState = "suspended"
    PowerStateUnknown    PowerState = "unknown"
)

// NetworkInfo 网络信息
type NetworkInfo struct {
    IPAddress string
    MAC       string
}
```

---

## 5. 数据库模型层设计

### 5.1 重构后的模型定义

```go
// internal/storage/models/vm.go

package storage

import "time"

// VM 虚拟机数据模型
// 只包含数据库表结构定义，不含业务逻辑
type VM struct {
    ID        uint      `gorm:"primarykey" json:"id"`
    VMKey     string    `gorm:"size:100;uniqueIndex:idx_vm_key_connection" json:"vm_key"`
    UUID      string    `gorm:"size:100;index" json:"uuid"`
    Name      string    `gorm:"size:200;not null" json:"name"`
    Datacenter string   `gorm:"size:100" json:"datacenter"`

    // 硬件配置
    CpuCount   int32  `json:"cpu_count"`
    CpuMHz     int32  `json:"cpu_mhz"`     // 单核频率
    MemoryMB   int32  `json:"memory_mb"`

    // 状态
    PowerState      string    `gorm:"size:50;index" json:"power_state"`
    ConnectionState string    `gorm:"size:50" json:"connection_state"`
    OverallStatus   string    `gorm:"size:50" json:"overall_status"`

    // 网络
    IPAddress string `gorm:"size:50" json:"ip_address"`

    // 其他
    GuestOS     string    `gorm:"size:100" json:"guest_os"`
    HostName    string    `gorm:"size:200" json:"host_name"`
    HostID      *uint     `gorm:"index" json:"host_id"`
    ClusterID   *uint     `gorm:"index" json:"cluster_id"`

    // 元数据
    ConnectionID uint      `gorm:"index:idx_vm_connection" json:"connection_id"`
    CollectedAt  time.Time `json:"collected_at"`
    CreatedAt    time.Time `json:"created_at"`
    UpdatedAt    time.Time `json:"updated_at"`
}

// TableName 指定表名
func (VM) TableName() string {
    return "vms"
}
```

### 5.2 快照表设计

```go
// internal/storage/models/snapshot.go

package storage

import "time"

// CollectionSnapshot 采集快照
// 记录一次采集任务的元数据
type CollectionSnapshot struct {
    ID           uint       `gorm:"primarykey" json:"id"`
    TaskID       uint       `gorm:"index:idx_snapshot_task" json:"task_id"`
    ConnectionID uint       `gorm:"index:idx_snapshot_connection" json:"connection_id"`
    SnapshotTime time.Time  `gorm:"index" json:"snapshot_time"`
    Status       string     `json:"status"` // pending, running, completed, failed

    // 统计信息
    ClusterCount int       `json:"cluster_count"`
    HostCount    int       `json:"host_count"`
    VMCount      int       `json:"vm_count"`
    MetricCount  int       `json:"metric_count"`

    // 错误信息
    ErrorMessage string    `json:"error_message,omitempty"`
    DurationMs   int64     `json:"duration_ms"`

    CreatedAt    time.Time `json:"created_at"`
}

// VMSnapshot 虚拟机快照
// 记录特定时间点的 VM 状态
type VMSnapshot struct {
    ID           uint      `gorm:"primarykey" json:"id"`
    SnapshotID   uint      `gorm:"index:idx_vm_snapshot_snapshot" json:"snapshot_id"`
    VMKey        string    `gorm:"size:120;index:idx_vm_snapshot_key" json:"vm_key"`
    UUID         string    `gorm:"size:100" json:"uuid"`
    Name         string    `gorm:"size:200" json:"name"`
    Datacenter   string    `gorm:"size:100" json:"datacenter"`

    CpuCount     int32     `json:"cpu_count"`
    MemoryMB     int32     `json:"memory_mb"`
    PowerState   string    `gorm:"size:50" json:"power_state"`
    IPAddress    string    `gorm:"size:50" json:"ip_address"`
    GuestOS      string    `gorm:"size:100" json:"guest_os"`
    HostName     string    `gorm:"size:200" json:"host_name"`
    OverallStatus string   `gorm:"size:50" json:"overall_status"`

    CollectedAt  time.Time `json:"collected_at"`
    CreatedAt    time.Time `json:"created_at"`
}

// MetricSnapshot 指标快照
type MetricSnapshot struct {
    ID           uint      `gorm:"primarykey" json:"id"`
    SnapshotID   uint      `gorm:"index:idx_metric_snapshot_snapshot" json:"snapshot_id"`
    VMKey        string    `gorm:"index:idx_metric_snapshot_vm" json:"vm_key"`
    MetricType   string    `gorm:"size:50;index:idx_metric_snapshot_type" json:"metric_type"`
    Timestamp    time.Time `gorm:"index:idx_metric_snapshot_time" json:"timestamp"`
    Value        float64   `json:"value"`
    CreatedAt    time.Time `json:"created_at"`
}
```

---

## 6. Mapper 层设计

```go
// internal/dto/mapper/vm_mapper.go

package mapper

import (
    "justfit/internal/domain/entity"
    "justfit/internal/dto/response"
    "justfit/internal/storage"
)

// VMMapper VM 数据映射器
type VMMapper struct{}

// NewVMMapper 创建映射器
func NewVMMapper() *VMMapper {
    return &VMMapper{}
}

// StorageToDomain 数据库模型 → 领域实体
func (m *VMMapper) StorageToDomain(model *storage.VM) *entity.VM {
    if model == nil {
        return nil
    }

    return &entity.VM{
        id:          model.ID,
        vmKey:       model.VMKey,
        name:        model.Name,
        datacenter:  model.Datacenter,
        cpu: entity.CPU{
            Count: model.CpuCount,
            MHz:   model.CpuMHz,
        },
        memory: entity.Memory{
            MB: model.MemoryMB,
        },
        powerState: entity.PowerState(model.PowerState),
        network: entity.NetworkInfo{
            IPAddress: model.IPAddress,
        },
        guestOS:     model.GuestOS,
        hostName:    model.HostName,
        collectedAt: model.CollectedAt,
    }
}

// StorageToDTO 数据库模型 → DTO
func (m *VMMapper) StorageToDTO(model *storage.VM) *response.VMResponse {
    if model == nil {
        return nil
    }

    return &response.VMResponse{
        ID:            model.ID,
        Name:          model.Name,
        Datacenter:    model.Datacenter,
        UUID:          model.UUID,
        CPUCount:      model.CpuCount,
        MemoryMB:      model.MemoryMB,
        MemoryGB:      float64(model.MemoryMB) / 1024,
        PowerState:    model.PowerState,
        IPAddress:     model.IPAddress,
        GuestOS:       model.GuestOS,
        HostName:      model.HostName,
        OverallStatus: model.OverallStatus,
        CollectedAt:   model.CollectedAt,
    }
}

// DomainToDTO 领域实体 → DTO
func (m *VMMapper) DomainToDTO(e *entity.VM) *response.VMResponse {
    if e == nil {
        return nil
    }

    return &response.VMResponse{
        ID:            e.GetID(),
        Name:          e.GetName(),
        CPUCount:      e.cpu.Count,
        MemoryMB:      e.memory.MB,
        MemoryGB:      e.GetMemoryGB(),
        PowerState:    string(e.powerState),
        CollectedAt:   e.collectedAt,
    }
}

// StorageToDTOList 批量转换
func (m *VMMapper) StorageToDTOList(models []storage.VM) []response.VMResponse {
    if len(models) == 0 {
        return []response.VMResponse{}
    }

    result := make([]response.VMResponse, len(models))
    for i := range models {
        if dto := m.StorageToDTO(&models[i]); dto != nil {
            result[i] = *dto
        }
    }
    return result
}
```

---

## 7. 前端类型定义

```typescript
// frontend/src/types/api.generated.ts
/**
 * 自动生成的 API 类型定义
 * 不要手动编辑
 * 生成时间: 2026-02-24T10:00:00Z
 */

// =============== 通用响应 ===============

export interface APIResponse<T = any> {
  success: boolean
  data?: T
  message?: string
  error?: string
  code?: string
  trace_id?: string
}

export interface PagedResponse<T = any> {
  total: number
  page: number
  size: number
  items: T[]
}

// =============== 连接相关 ===============

export interface ConnectionRequest {
  name: string
  platform: 'vcenter' | 'h3c-uis'
  host: string
  port: number
  username: string
  password: string
  insecure: boolean
}

export interface ConnectionResponse {
  id: number
  name: string
  platform: string
  host: string
  port: number
  username: string
  insecure: boolean
  status: string
  created_at: string
  last_sync?: string
}

export interface ConnectionListItem {
  id: number
  name: string
  platform: string
  host: string
  status: string
  vm_count: number
  last_sync?: string
}

// =============== 资源相关 ===============

export interface VMResponse {
  id: number
  name: string
  datacenter: string
  uuid: string
  cpu_count: number
  memory_mb: number
  memory_gb: number
  power_state: string
  ip_address?: string
  guest_os?: string
  host_name?: string
  overall_status?: string
  collected_at: string
}

export interface HostResponse {
  id: number
  name: string
  datacenter: string
  ip_address: string
  cpu_cores: number
  cpu_mhz: number
  memory_mb: number
  memory_gb: number
  num_vms: number
  power_state: string
  overall_status: string
  collected_at: string
}

export interface ClusterResponse {
  id: number
  name: string
  datacenter: string
  total_cpu: number
  total_memory: number
  total_memory_gb: number
  num_hosts: number
  num_vms: number
  status: string
  collected_at: string
}

export interface MetricPoint {
  timestamp: number
  value: number
}

export interface MetricsResponse {
  vm_id: number
  vm_name: string
  metric_type: string
  start_time: string
  end_time: string
  data_points: MetricPoint[]
}

// =============== 任务相关 ===============

export interface CreateCollectionTaskRequest {
  connection_id: number
  selected_vms: string[]
  data_types: string[]
  metrics_days: number
  concurrency: number
}

export interface CreateAnalysisTaskRequest {
  connection_id: number
  analysis_types: string[]
  config: Record<string, any>
}

export interface TaskResponse {
  id: number
  type: string
  name: string
  status: string
  progress: number
  error?: string
  created_at: string
  started_at?: string
  completed_at?: string
  duration_ms?: number
  connection_id?: number
  connection_name?: string
  platform?: string
  total_vms?: number
  collected_vms?: number
}

export interface TaskDetailResponse extends TaskResponse {
  current_step?: string
  config?: Record<string, any>
  result?: Record<string, any>
  analysis_results?: Record<string, boolean>
}

export interface TaskLogEntry {
  timestamp: string
  level: 'info' | 'warning' | 'error'
  message: string
  fields?: Record<string, any>
}

// =============== 分析相关 ===============

export interface ZombieVMResult {
  vm_name: string
  datacenter: string
  host: string
  cpu_count: number
  memory_mb: number
  cpu_usage: number
  memory_usage: number
  disk_io_rate: number
  network_rate: number
  confidence: number
  days_low_usage: number
  evidence: string[]
  recommendation: string
}

export interface RightSizeResult {
  vm_name: string
  datacenter: string
  current_cpu: number
  current_memory_mb: number
  current_memory_gb: number
  recommended_cpu: number
  recommended_memory_mb: number
  recommended_memory_gb: number
  adjustment_type: 'none' | 'up' | 'down'
  risk_level: 'low' | 'medium' | 'high'
  estimated_saving: string
  confidence: number
}

export interface TidalResult {
  vm_name: string
  datacenter: string
  pattern: 'daily' | 'weekly' | 'none'
  stability_score: number
  peak_hours: number[]
  peak_days: number[]
  recommendation: string
  estimated_saving: string
}

export interface HealthScoreResult {
  connection_id: number
  connection_name: string
  overall_score: number
  health_level: 'excellent' | 'good' | 'fair' | 'poor'
  resource_balance: number
  overcommit_risk: number
  hotspot_concentration: number
  total_clusters: number
  total_hosts: number
  total_vms: number
  risk_items: string[]
  recommendations: string[]
}
```

---

## 8. 数据流转示意图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (TypeScript)                      │
│                                                                  │
│  interface VMRequest {  connection_id: number, ... }            │
│           │                                                      │
│           ▼                                                      │
│  api.createTask(request) ──────────────────────────────────┐   │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
                                                                   │
                                                                   │ Wails IPC (JSON)
                                                                   │
┌──────────────────────────────────────────────────────────────────┘
│                        后端 (Go)                                │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  app.go (应用层)                                             ││
│  │    ┌───────────────────────────────────────────────────────┐││
│  │    │ func CreateTask(req *request.CreateTaskRequest)      │││
│  │    │   → 参数验证                                          │││
│  │    │   → 调用领域服务                                      │││
│  │    └───────────────────────────────────────────────────────┘││
│  │                              │                                ││
│  └───────────────────────────────┼────────────────────────────┘│
│                                  ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  domain/service (领域服务)                                  ││
│  │    ┌───────────────────────────────────────────────────────┐││
│  │    │ taskService.Create(config)                            │││
│  │    │   → 业务逻辑处理                                       │││
│  │    │   → 使用领域实体                                       │││
│  │    └───────────────────────────────────────────────────────┘││
│  │                              │                                ││
│  └───────────────────────────────┼────────────────────────────┘│
│                                  ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  storage/repository (数据仓储)                               ││
│  │    ┌───────────────────────────────────────────────────────┐││
│  │    │ taskRepo.Create(&storage.Task{})                      │││
│  │    │   → GORM 操作                                          │││
│  │    └───────────────────────────────────────────────────────┘││
│  │                              │                                ││
│  └───────────────────────────────┼────────────────────────────┘│
│                                  ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  SQLite Database                                            ││
│  │    表：tasks, task_snapshots, vm_snapshots, ...            ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                  │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │  返回路径                                                      ││
│  │    storage.Task → mapper.ToDTO() → response.TaskResponse   ││
│  │    → Wails 序列化 → 前端 VMResponse                         ││
│  └─────────────────────────────────────────────────────────────┘│
└──────────────────────────────────────────────────────────────────┘
```
